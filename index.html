<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeSurf Kids • Spark Edition</title>
  <meta name="description" content="SafeSurf Kids helps children learn how to stay safe with ICT — colorful lessons, quick quizzes, and Spark the AI helper." />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --mint: #06D6A0;
      --blue: #118AB2;
      --yellow: #FFD166;
      --pink: #EF476F;
      --purple: #8E63D1;
      --ink: #173043;
      --bg: #f7fbff;
      --card: #ffffff;
      --muted: #527288;
      --radius: 16px;
      --shadow: 0 12px 30px rgba(17, 138, 178, 0.18);
    }

    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      background: radial-gradient(1200px 800px at 10% -10%, #e7fff5 0%, #f7fbff 48%, #ffffff 100%);
      color: var(--ink);
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.45;
      scroll-behavior: smooth;
    }

    .visually-hidden {
      position: absolute !important; height: 1px; width: 1px; overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; border: 0; padding: 0; margin: -1px;
    }

    /* Animated header */
    .site-header {
      position: relative;
      display: flex; align-items: center; justify-content: space-between;
      padding: 18px 20px;
      color: white;
      overflow: hidden;
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
      box-shadow: 0 10px 40px rgba(17,138,178,.25);
      background: linear-gradient(135deg, var(--mint), var(--blue), var(--purple));
      background-size: 300% 300%;
      animation: moveGrad 12s ease infinite;
    }
    @keyframes moveGrad {
      0% { background-position: 0% 50% }
      50% { background-position: 100% 50% }
      100% { background-position: 0% 50% }
    }

    .brand { display: flex; align-items: center; gap: 14px; }
    .logo {
      width: 54px; height: 54px;
      filter: drop-shadow(0 6px 16px rgba(0,0,0,.25));
      transform-origin: 50% 50%;
      animation: float 4.6s ease-in-out infinite;
    }
    @keyframes float { 0%,100% { transform: translateY(0) } 50% { transform: translateY(4px) } }

    .title { margin: 0; font-weight: 800; letter-spacing: 0.2px; }
    .tagline { margin: 2px 0 0; opacity: 0.98; font-weight: 700; }

    .header-actions { display: flex; gap: 16px; align-items: center; }

    .achievements {
      background: rgba(255, 255, 255, 0.16);
      padding: 8px 12px; border-radius: 999px;
      display: flex; gap: 10px; align-items: center;
      backdrop-filter: blur(2px);
    }
    .star { font-size: 18px; }

    .progress-ring {
      --size: 42px;
      width: var(--size); height: var(--size);
      border-radius: 50%;
      background:
        conic-gradient(var(--yellow) var(--angle, 0%), rgba(255,255,255,.25) 0),
        radial-gradient(circle at 50% 50%, #fff 60%, transparent 61%);
      display: grid; place-items: center; color: #073b32; font-weight: 900; font-size: 12px;
      box-shadow: inset 0 0 0 3px rgba(255,255,255,.6);
    }

    .lang-toggle select {
      border: none; border-radius: 999px; padding: 8px 12px;
      background: #fff; color: var(--ink); font-weight: 800;
    }

    .main-nav {
      display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 16px;
      background: #fff; box-shadow: var(--shadow); margin: 10px 12px 0; border-radius: 14px;
    }
    .nav-btn {
      background: var(--yellow); border: 0; border-radius: 999px; padding: 10px 16px;
      font-weight: 900; color: var(--ink); cursor: pointer;
      transition: transform 0.06s ease, background 0.2s ease, box-shadow .2s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,.06);
    }
    .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,.10) }
    .nav-btn:focus-visible { outline: 3px solid var(--purple); }
    .nav-btn.active { background: var(--mint); color: #083d2f; }

    main { padding: 22px 16px 90px; max-width: 1120px; margin: 0 auto; }

    .view { display: none }
    .view.active { display: block }

    /* Hero */
    .hero {
      position: relative;
      background: linear-gradient(135deg, #ffffff, #f5fff9);
      border-radius: var(--radius); box-shadow: var(--shadow); padding: 26px; overflow: hidden;
      isolation: isolate;
    }
    .hero::after {
      content: "";
      position: absolute; right: -120px; top: -120px; width: 320px; height: 320px;
      background: radial-gradient(closest-side, rgba(6,214,160,.45), transparent 70%);
      filter: blur(20px); z-index: -1; border-radius: 50%;
      animation: pulse 6s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { transform: scale(1) } 50% { transform: scale(1.05) } }

    .hero-actions { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    .cta {
      display: inline-block; background: var(--pink); color: #fff;
      padding: 12px 18px; border-radius: 14px; text-decoration: none; font-weight: 900;
      transition: transform 0.06s ease, opacity 0.2s ease, box-shadow .2s ease;
      box-shadow: 0 8px 16px rgba(239,71,111,.25);
    }
    .cta:hover { transform: translateY(-2px); opacity: .96; box-shadow: 0 12px 22px rgba(239,71,111,.32) }
    .cta.secondary { background: var(--blue); box-shadow: 0 8px 16px rgba(17,138,178,.25); }

    /* Cards */
    .quick-cards, .modules {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px; margin-top: 16px;
    }

    .card {
      background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 16px; transition: transform 0.06s ease, box-shadow 0.2s ease, background .2s ease;
      text-align: left; position: relative; overflow: hidden;
    }
    .card::before {
      content: ""; position: absolute; right: -50px; top: -50px; width: 140px; height: 140px;
      background: radial-gradient(closest-side, rgba(17,138,178,.12), transparent 70%); transform: rotate(12deg);
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 14px 34px rgba(17, 138, 178, 0.28); }

    .module-detail {
      background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 18px; margin-top: 18px;
    }

    .muted { color: var(--muted); }
    .tiny { font-size: .92rem; }

    /* Chat */
    .safety-banner {
      background: #fff3c9; border: 2px dashed var(--yellow); padding: 12px; border-radius: 12px; margin-bottom: 12px; font-weight: 900;
    }
    .age-toggle { display: flex; gap: 16px; margin-bottom: 10px; align-items: center; font-weight: 800; }
    .chat { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .chat-log {
      max-height: 400px; min-height: 240px; overflow: auto; padding: 16px;
      background: linear-gradient(180deg, #fdfdff, #f5fbff);
    }
    .chat-bubble {
      display: inline-block; padding: 10px 12px; border-radius: 14px; margin: 8px 0; max-width: 80%;
      line-height: 1.45; animation: slideIn .18s ease;
    }
    .chat-bubble.user { background: var(--blue); color: #fff; border-bottom-right-radius: 4px; }
    .chat-bubble.spark { background: #eefcf6; border: 2px solid var(--mint); color: #0b5a49; border-bottom-left-radius: 4px; }
    @keyframes slideIn { from { transform: translateY(4px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }

    .typing-dots { display: inline-flex; gap: 3px; }
    .typing-dots span { width: 6px; height: 6px; border-radius: 999px; background: #0b5a49; opacity: .4; animation: blink 1s infinite; }
    .typing-dots span:nth-child(2){ animation-delay: .15s } .typing-dots span:nth-child(3){ animation-delay: .3s }
    @keyframes blink { 50% { opacity: 1 } }

    .chat-form { display: flex; gap: 10px; border-top: 1px solid #e7eef5; padding: 12px; }
    .chat-form input[type="text"] { flex: 1; padding: 12px 14px; border-radius: 12px; border: 2px solid #d6e5f2; font-size: 1rem; }
    .chat-form input:focus-visible { outline: none; border-color: var(--purple); }
    .send-btn { background: var(--mint); color: #083d2f; border: 0; border-radius: 12px; font-weight: 900; padding: 12px 16px; cursor: pointer; box-shadow: 0 8px 16px rgba(6,214,160,.22); }
    .send-btn:hover { filter: brightness(0.95); }

    .parent-grid, .resources-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .badges { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .badge {
      background: #f1f6ff; color: #0a3e8c; border-radius: 999px; padding: 6px 10px; font-weight: 800; font-size: .9rem;
      border: 2px solid #cde2ff;
    }

    .site-footer { text-align: center; color: var(--muted); padding: 28px 16px; }
    button, a, input, select { transition: transform .05s ease, box-shadow .2s ease, background .2s ease }
    button:active, a:active { transform: translateY(1px) }

    /* Confetti */
    #confetti { pointer-events: none; position: fixed; inset: 0; }
    .confetti-star {
      position: absolute; font-size: 18px; line-height: 1; animation: floatDown 1.8s ease-out forwards; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.12));
    }
    @keyframes floatDown { 0% { transform: translateY(-20px) rotate(0); opacity: 0 } 15% { opacity: 1 } 100% { transform: translateY(90vh) rotate(260deg); opacity: 0 } }

    /* Reveal animations */
    .reveal { opacity: 0; transform: translateY(10px); transition: all .5s ease; }
    .reveal.show { opacity: 1; transform: translateY(0) }

    @media (max-width: 720px) {
      .title { font-size: 1.2rem; }
      .tagline { font-size: 0.95rem; }
    }
  </style>
</head>
<body>
  <header class="site-header" role="banner">
    <div class="brand">
      <!-- Animated gradient logo -->
      <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96" aria-hidden="true" focusable="false">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#06D6A0"/>
            <stop offset="100%" stop-color="#118AB2"/>
          </linearGradient>
        </defs>
        <circle cx="48" cy="48" r="44" fill="url(#g)"></circle>
        <path d="M48 18c14 8 22 10 32 12-1 20-7 34-32 48-25-14-31-28-32-48 10-2 18-4 32-12z" fill="#fff" opacity="0.9"/>
        <path d="M35 49l8 8 18-18" stroke="#06D6A0" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div>
        <h1 id="app-title" class="title" data-i18n="app.title">SafeSurf Kids</h1>
        <p class="tagline" data-i18n="app.tagline">Learn to stay safe online with Spark! ✨</p>
        <div class="badges">
          <span class="badge">Child-friendly</span>
          <span class="badge">No personal data</span>
          <span class="badge">Mobile ready</span>
        </div>
      </div>
    </div>

    <div class="header-actions">
      <div class="achievements" aria-live="polite" title="Your progress">
        <div class="progress-ring" id="progress-ring"><span id="progress-text">0%</span></div>
        <span class="star">⭐</span>
        <span data-i18n="app.stars">Stars:</span>
        <strong id="star-count">0</strong>
      </div>

      <div class="lang-toggle" aria-label="Language">
        <label for="lang-select" class="visually-hidden">Language</label>
        <select id="lang-select" aria-label="Language select">
          <option value="en" selected>English</option>
          <option value="es">Español</option>
        </select>
      </div>
    </div>
  </header>

  <nav class="main-nav" role="navigation" aria-label="Main">
    <button class="nav-btn active" data-target="home" data-i18n="nav.home">Home</button>
    <button class="nav-btn" data-target="learn" data-i18n="nav.learn">Learn</button>
    <button class="nav-btn" data-target="ask" data-i18n="nav.ask">Ask Spark</button>
    <button class="nav-btn" data-target="parents" data-i18n="nav.parents">Parent & Carer Corner</button>
    <button class="nav-btn" data-target="resources" data-i18n="nav.resources">Resources</button>
  </nav>

  <main>
    <!-- Home -->
    <section id="home" class="view active" aria-labelledby="home-heading">
      <div class="hero reveal">
        <h2 id="home-heading" data-i18n="home.heading">Welcome! 🌈</h2>
        <p data-i18n="home.sub">Let’s learn how to be safe and kind with ICT — on the internet, in apps, and games.</p>
        <div class="hero-actions">
          <a href="#learn" class="cta" data-nav="learn" data-i18n="home.startLearning">Start Learning</a>
          <a href="#ask" class="cta secondary" data-nav="ask" data-i18n="home.askSpark">Ask the AI</a>
        </div>
      </div>

      <div class="quick-cards" role="list">
        <div class="card reveal" role="listitem" tabindex="0">
          <h3>🔐 Strong Passwords</h3>
          <p>Use long, secret passwords. Turn on 2FA!</p>
        </div>
        <div class="card reveal" role="listitem" tabindex="0">
          <h3>🛡️ Privacy & Sharing</h3>
          <p>Think before you post. Keep personal info private.</p>
        </div>
        <div class="card reveal" role="listitem" tabindex="0">
          <h3>💬 Be Kind Online</h3>
          <p>Report bullying. Save messages. Talk to an adult.</p>
        </div>
        <div class="card reveal" role="listitem" tabindex="0">
          <h3>🎮 Gaming Safety</h3>
          <p>Use safe chats. Watch in‑app purchases. Take breaks!</p>
        </div>
      </div>
    </section>

    <!-- Learn -->
    <section id="learn" class="view" aria-labelledby="learn-heading">
      <h2 id="learn-heading" class="reveal" data-i18n="learn.heading">Learn: Safety Modules</h2>
      <p class="muted reveal" data-i18n="learn.desc">Tap a card to read tips, try a scenario, and take a quick quiz.</p>
      <div id="modules" class="modules" role="list"></div>
      <div id="module-detail" class="module-detail reveal" hidden aria-live="polite"></div>
    </section>

    <!-- Ask Spark (AI chat) -->
    <section id="ask" class="view" aria-labelledby="ask-heading">
      <h2 id="ask-heading" class="reveal" data-i18n="ask.heading">Ask Spark (AI)</h2>
      <div class="safety-banner reveal" role="note" data-i18n="ask.banner">
        Never share your real name, address, phone, school, or passwords.
      </div>

      <div class="age-toggle reveal" role="group" aria-label="Age group">
        <label><input type="radio" name="age" value="8-10" checked /> 8–10</label>
        <label><input type="radio" name="age" value="11-13" /> 11–13</label>
      </div>

      <div class="chat reveal" aria-label="Chat with Spark">
        <div id="chat-log" class="chat-log" role="log" aria-live="polite" aria-relevant="additions"></div>

        <form id="chat-form" class="chat-form" autocomplete="off">
          <label for="chat-input" class="visually-hidden">Your message</label>
          <input id="chat-input" name="message" type="text" minlength="1" maxlength="600"
                 placeholder="Ask me about staying safe online!" aria-label="Ask me about staying safe online!" required />
          <button type="submit" class="send-btn">Send</button>
        </form>
        <p class="tiny muted" data-i18n="ask.footer">We don’t store chats. Be kind and keep info private.</p>
      </div>
    </section>

    <!-- Parent & Carer Corner -->
    <section id="parents" class="view" aria-labelledby="parents-heading">
      <h2 id="parents-heading" class="reveal" data-i18n="parents.heading">Parent & Carer Corner</h2>
      <div class="parent-grid">
        <article class="card reveal">
          <h3 data-i18n="parents.tipsTitle">Quick Tips</h3>
          <ul>
            <li data-i18n="parents.tip1">Talk early and often about online kindness and privacy.</li>
            <li data-i18n="parents.tip2">Set clear rules together (bedtime, screens out of bedrooms).</li>
            <li data-i18n="parents.tip3">Use family accounts and turn on parental controls where helpful.</li>
            <li data-i18n="parents.tip4">Learn the games and apps they use; play together sometimes.</li>
            <li data-i18n="parents.tip5">Keep devices updated; use strong passwords & 2FA.</li>
          </ul>
        </article>
        <article class="card reveal">
          <h3 data-i18n="parents.startersTitle">Conversation Starters</h3>
          <ul>
            <li data-i18n="parents.start1">How do you decide what to share online?</li>
            <li data-i18n="parents.start2">What would you do if someone was unkind or asked for private info?</li>
            <li data-i18n="parents.start3">Which games or creators make you feel good? Why?</li>
          </ul>
        </article>
        <article class="card reveal">
          <h3 data-i18n="parents.signsTitle">Signs to Watch For</h3>
          <ul>
            <li data-i18n="parents.sign1">Sudden worry about going online or changes in mood.</li>
            <li data-i18n="parents.sign2">Secret new accounts or hiding screens.</li>
            <li data-i18n="parents.sign3">Unexplained charges or new “friends.”</li>
          </ul>
        </article>
        <article class="card reveal">
          <h3 data-i18n="parents.controlsTitle">Parental Controls Basics</h3>
          <p data-i18n="parents.controlsDesc">Use built‑in tools on devices, consoles, and routers to filter content, set time limits, and restrict purchases. Review settings together so kids understand why.</p>
        </article>
      </div>
    </section>

    <!-- Resources -->
    <section id="resources" class="view" aria-labelledby="resources-heading">
      <h2 id="resources-heading" class="reveal" data-i18n="resources.heading">Resources</h2>
      <div class="resources-grid">
        <article class="card reveal">
          <h3 data-i18n="resources.helpTitle">If you need help</h3>
          <ul>
            <li data-i18n="resources.help1">Talk to a trusted adult (parent, carer, teacher, counselor).</li>
            <li data-i18n="resources.help2">If you are in danger, contact local emergency services right away.</li>
            <li data-i18n="resources.help3">Use app/game “Report” and “Block” features when needed.</li>
          </ul>
        </article>
        <article class="card reveal">
          <h3 data-i18n="resources.linksTitle">Helpful links</h3>
          <ul class="links">
            <li><a href="https://www.childline.org.uk" target="_blank" rel="noopener">Childline (UK)</a></li>
            <li><a href="https://www.kidshelpphone.ca" target="_blank" rel="noopener">Kids Help Phone (CA)</a></li>
            <li><a href="https://www.stopbullying.gov" target="_blank" rel="noopener">StopBullying.gov (US)</a></li>
            <li><a href="https://www.commonsensemedia.org" target="_blank" rel="noopener">Common Sense Media</a></li>
          </ul>
          <p class="tiny muted" data-i18n="resources.note">Links are examples — find local resources for your area.</p>
        </article>
      </div>
    </section>
  </main>

  <div id="confetti" aria-hidden="true"></div>

  <footer class="site-footer">
    <p>© <span id="year"></span> SafeSurf Kids · <span class="tiny" data-i18n="footer.privacy">We don’t collect personal data.</span></p>
  </footer>

  <script>
    // ===== Config (kept as-is to use your existing Worker) =====
    const USE_BACKEND = true;
    const BACKEND_URL = 'https://spark-ai-sethu.sethu-spark.workers.dev';

    // ===== Utilities & State =====
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

    let strings = {};
    let lang = 'en';
    let completedModules = new Set(JSON.parse(localStorage.getItem('ss-completed') || '[]'));
    let ageGroup = '8-10';

    // Year in footer
    $('#year').textContent = new Date().getFullYear();

    // Nav handling
    $$('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target;
        $$('.view').forEach(v => v.classList.toggle('active', v.id === target));
        $$('.nav-btn').forEach(b => b.classList.toggle('active', b === btn));
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
    $$('[data-nav="learn"]').forEach(a => a.addEventListener('click', e => { e.preventDefault(); $('[data-target="learn"]').click(); }));
    $$('[data-nav="ask"]').forEach(a => a.addEventListener('click', e => { e.preventDefault(); $('[data-target="ask"]').click(); }));

    // Reveal animations
    const io = new IntersectionObserver(entries => {
      entries.forEach(e => e.target.classList.toggle('show', e.isIntersecting));
    }, { threshold: 0.12 });
    $$('.reveal').forEach(el => io.observe(el));

    // ===== Localization =====
    const STRINGS = {
      en: {
        app: { title: "SafeSurf Kids", tagline: "Learn to stay safe online with Spark! ✨", stars: "Stars:" },
        nav: { home: "Home", learn: "Learn", ask: "Ask Spark", parents: "Parent & Carer Corner", resources: "Resources" },
        home: { heading: "Welcome! 🌈", sub: "Let’s learn how to be safe and kind with ICT — on the internet, in apps, and games.", startLearning: "Start Learning", askSpark: "Ask the AI" },
        learn: { heading: "Learn: Safety Modules", desc: "Tap a card to read tips, try a scenario, and take a quick quiz." },
        ask: { heading: "Ask Spark (AI)", banner: "Never share your real name, address, phone, school, or passwords.", footer: "We don’t store chats. Be kind and keep info private." },
        parents: {
          heading: "Parent & Carer Corner", tipsTitle: "Quick Tips",
          tip1: "Talk early and often about online kindness and privacy.",
          tip2: "Set clear rules together (bedtime, screens out of bedrooms).",
          tip3: "Use family accounts and turn on parental controls where helpful.",
          tip4: "Learn the games and apps they use; play together sometimes.",
          tip5: "Keep devices updated; use strong passwords & 2FA.",
          startersTitle: "Conversation Starters",
          start1: "How do you decide what to share online?",
          start2: "What would you do if someone was unkind or asked for private info?",
          start3: "Which games or creators make you feel good? Why?",
          signsTitle: "Signs to Watch For",
          sign1: "Sudden worry about going online or changes in mood.",
          sign2: "Secret new accounts or hiding screens.",
          sign3: "Unexplained charges or new “friends.”",
          controlsTitle: "Parental Controls Basics",
          controlsDesc: "Use built‑in tools on devices, consoles, and routers to filter content, set time limits, and restrict purchases. Review settings together so kids understand why."
        },
        resources: {
          heading: "Resources",
          helpTitle: "If you need help",
          help1: "Talk to a trusted adult (parent, carer, teacher, counselor).",
          help2: "If you are in danger, contact local emergency services right away.",
          help3: "Use app/game “Report” and “Block” features when needed.",
          linksTitle: "Helpful links",
          note: "Links are examples — find local resources for your area."
        },
        footer: { privacy: "We don’t collect personal data." }
      },
      es: {
        app: { title: "SafeSurf Kids", tagline: "¡Aprende a estar seguro en línea con Spark! ✨", stars: "Estrellas:" },
        nav: { home: "Inicio", learn: "Aprender", ask: "Preguntar a Spark", parents: "Para familias y cuidadores", resources: "Recursos" },
        home: { heading: "¡Bienvenid@! 🌈", sub: "Aprendamos a ser seguros y amables con las TIC — en internet, apps y juegos.", startLearning: "Comenzar", askSpark: "Preguntar a la IA" },
        learn: { heading: "Aprender: Módulos de seguridad", desc: "Toca una tarjeta para leer consejos, probar un escenario y hacer un mini cuestionario." },
        ask: { heading: "Pregunta a Spark (IA)", banner: "Nunca compartas tu nombre real, dirección, teléfono, escuela ni contraseñas.", footer: "No guardamos los chats. Sé amable y cuida tu privacidad." },
        parents: {
          heading: "Para familias y cuidadores", tipsTitle: "Consejos rápidos",
          tip1: "Hablen temprano y con frecuencia sobre amabilidad y privacidad.",
          tip2: "Acordar reglas claras (hora de dormir, sin pantallas en el dormitorio).",
          tip3: "Usar cuentas familiares y controles parentales cuando ayuden.",
          tip4: "Conozcan los juegos y apps que usan; jueguen juntos a veces.",
          tip5: "Mantener dispositivos actualizados; contraseñas fuertes y 2FA.",
          startersTitle: "Para conversar",
          start1: "¿Cómo decides qué compartir en línea?",
          start2: "¿Qué harías si alguien es agresivo o pide info privada?",
          start3: "¿Qué juegos o creadores te hacen sentir bien? ¿Por qué?",
          signsTitle: "Señales a observar",
          sign1: "Preocupación por conectarse o cambios de ánimo.",
          sign2: "Cuentas nuevas secretas u ocultar la pantalla.",
          sign3: "Cargos extraños o “amigos” nuevos.",
          controlsTitle: "Controles parentales básicos",
          controlsDesc: "Usa herramientas en dispositivos, consolas y routers para filtrar contenido, limitar tiempo y restringir compras. Revisen ajustes juntos para entender el porqué."
        },
        resources: {
          heading: "Recursos",
          helpTitle: "Si necesitas ayuda",
          help1: "Habla con un adulto de confianza (madre/padre, cuidador, profesor, orientador).",
          help2: "Si estás en peligro, contacta a los servicios de emergencia locales.",
          help3: "Usa “Reportar” y “Bloquear” en las apps/juegos cuando haga falta.",
          linksTitle: "Enlaces útiles",
          note: "Los enlaces son ejemplos — busca recursos locales de tu zona."
        },
        footer: { privacy: "No recopilamos datos personales." }
      }
    };

    function applyStrings() {
      $$('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        const val = key.split('.').reduce((acc, k) => acc && acc[k], strings);
        if (typeof val === 'string') el.textContent = val;
      });
    }
    $('#lang-select').addEventListener('change', (e) => {
      lang = e.target.value;
      strings = STRINGS[lang] || STRINGS.en;
      applyStrings();
    });

    // ===== Lessons / Modules (expanded to 9) =====
    const LESSONS = [
      {
        id: "passwords",
        emoji: "🔐",
        title: "Strong Passwords & 2FA",
        subtitle: "Make your accounts tough to crack!",
        tips: [
          "Use long passwords (12+). Try three random words.",
          "Never share passwords with friends.",
          "Use a different password for each account.",
          "Turn on 2FA — a code from an app or text.",
          "Keep devices locked with a PIN or passcode."
        ],
        scenario: {
          prompt: "A message says: “Your account is locked! Send your password to fix it.” What do you do?",
          choices: [
            { text: "Send my password to unlock it", isCorrect: false, feedback: "Nope! Never share passwords. This is likely a scam." },
            { text: "Ignore and go to the official app/website", isCorrect: true, feedback: "Yes! Use the real app/website and change your password if worried." },
            { text: "Ask friends if they got the same message", isCorrect: false, feedback: "Better to check the official site instead of asking friends." }
          ]
        },
        quiz: [
          { q: "What makes a strong password?", options: ["Your name + birthday", "12+ characters with random words", "12345678"], answerIndex: 1 },
          { q: "What is 2FA?", options: ["A gaming level", "A code to prove it’s you", "An emoji"], answerIndex: 1 },
          { q: "Should you share passwords?", options: ["Yes", "No"], answerIndex: 1 }
        ]
      },
      {
        id: "privacy",
        emoji: "🛡️",
        title: "Privacy & Sharing",
        subtitle: "Think before you post.",
        tips: [
          "Keep real name, address, phone, and school private.",
          "Turn off location sharing in apps you don’t trust.",
          "Check privacy settings for posts and profiles.",
          "Ask before sharing photos of friends.",
          "Post kindly — your future self will thank you!"
        ],
        scenario: {
          prompt: "A new friend asks for your address to send a gift. What do you do?",
          choices: [
            { text: "Share it in chat", isCorrect: false, feedback: "Not safe. Never share your home address online." },
            { text: "Say no and ask a trusted adult", isCorrect: true, feedback: "Great choice! Keep private info safe and talk to an adult." },
            { text: "Give a nearby place instead", isCorrect: false, feedback: "Still risky. Don’t share locations online." }
          ]
        },
        quiz: [
          { q: "What info should stay private?", options: ["Real name & address", "Favorite color"], answerIndex: 0 },
          { q: "Who should you ask before posting a group photo?", options: ["No one", "The people in the photo"], answerIndex: 1 },
          { q: "What should you do with location sharing?", options: ["Leave it on always", "Turn it off unless needed"], answerIndex: 1 }
        ]
      },
      {
        id: "cyberbullying",
        emoji: "💬",
        title: "Cyberbullying",
        subtitle: "Be kind, block, and report.",
        tips: [
          "If someone is unkind, don’t reply. Save evidence.",
          "Use block and report. It’s not tattling — it’s safety.",
          "Talk to a trusted adult right away.",
          "Be kind when you comment and message.",
          "Check in on friends who seem down."
        ],
        scenario: {
          prompt: "Someone keeps sending mean messages in a group chat. What now?",
          choices: [
            { text: "Send mean messages back", isCorrect: false, feedback: "This can make it worse. Don’t reply." },
            { text: "Block, report, and tell a trusted adult", isCorrect: true, feedback: "That’s right! Block/report and talk to an adult." },
            { text: "Leave the group and never tell anyone", isCorrect: false, feedback: "Leaving can help, but also tell a trusted adult." }
          ]
        },
        quiz: [
          { q: "What should you keep as evidence?", options: ["Screenshots", "Nothing"], answerIndex: 0 },
          { q: "Who can you talk to?", options: ["A trusted adult", "No one"], answerIndex: 0 },
          { q: "What can apps help you do?", options: ["Block and report", "Send mean messages"], answerIndex: 0 }
        ]
      },
      {
        id: "scams",
        emoji: "🕵️",
        title: "Scams & Phishing",
        subtitle: "Spot tricks before they get you.",
        tips: [
          "Don’t click strange links or attachments.",
          "Check the sender’s address — fakes look similar.",
          "Look for spelling mistakes and urgent threats.",
          "Use the official website or app to check your account.",
          "Ask an adult if anything feels off."
        ],
        scenario: {
          prompt: "You win a “free phone” if you click a link. It asks for your login. What now?",
          choices: [
            { text: "Enter my login to get the prize", isCorrect: false, feedback: "This is a phishing trick. Don’t share logins." },
            { text: "Close it and tell a trusted adult", isCorrect: true, feedback: "Good move! Stay safe and double-check with an adult." },
            { text: "Click the link but don’t type anything", isCorrect: false, feedback: "Even clicking can be risky. Better to close it." }
          ]
        },
        quiz: [
          { q: "Which looks suspicious?", options: ["Urgent prizes & weird links", "A message from your parent"], answerIndex: 0 },
          { q: "Where should you check your account?", options: ["Official app/website", "Random link"], answerIndex: 0 },
          { q: "Who can help if unsure?", options: ["A trusted adult", "A stranger online"], answerIndex: 0 }
        ]
      },
      {
        id: "gaming",
        emoji: "🎮",
        title: "Gaming Safety & Screen Time",
        subtitle: "Play fun, play fair, take breaks.",
        tips: [
          "Use family-friendly chats and block rude players.",
          "Ask before buying in-game items.",
          "Take eye-and-body breaks every 30–60 mins.",
          "Don’t share private info in voice chat.",
          "Balance games with sleep, school, and friends."
        ],
        scenario: {
          prompt: "A player asks for your login to ‘boost’ your account. What do you do?",
          choices: [
            { text: "Share it — I want better items", isCorrect: false, feedback: "Nope! Never share logins. They could steal your account." },
            { text: "Say no, block the player, and report", isCorrect: true, feedback: "Perfect. Protect your account and move on." },
            { text: "Share only the password", isCorrect: false, feedback: "That’s the most secret part. Keep it private!" }
          ]
        },
        quiz: [
          { q: "How often to take breaks?", options: ["Every 30–60 mins", "Never"], answerIndex: 0 },
          { q: "What about in-app purchases?", options: ["Ask a parent/carer first", "Buy anything"], answerIndex: 0 },
          { q: "What info should you keep private in voice chat?", options: ["Your address & school", "Game tips"], answerIndex: 0 }
        ]
      },
      {
        id: "footprints",
        emoji: "👣",
        title: "Digital Footprints",
        subtitle: "What you post can last.",
        tips: [
          "Posts can travel fast and be saved.",
          "Be proud of what future-you will see.",
          "Think: Is it kind? Is it true? Is it needed?",
          "Ask before posting photos of others.",
          "Review old posts and clean up."
        ],
        scenario: {
          prompt: "You find a silly video of your friend and want to post it. What now?",
          choices: [
            { text: "Post it — it’s funny!", isCorrect: false, feedback: "It could hurt feelings. Always ask first." },
            { text: "Ask your friend if it’s okay to share", isCorrect: true, feedback: "Yes! Get permission before posting." },
            { text: "Post it and remove later", isCorrect: false, feedback: "It might be copied. Better to ask first." }
          ]
        },
        quiz: [
          { q: "What is a digital footprint?", options: ["Your shoe size", "Your online posts and actions"], answerIndex: 1 },
          { q: "Who should you ask before sharing group pics?", options: ["No one", "The people in the photo"], answerIndex: 1 },
          { q: "Can deleted posts always vanish?", options: ["Yes", "Not always — others may save them"], answerIndex: 1 }
        ]
      },
      {
        id: "deepfakes",
        emoji: "🧠",
        title: "AI, Photos & Deepfakes",
        subtitle: "Not everything online is real.",
        tips: [
          "Strange videos may be edited or AI-made.",
          "Check trusted news or official pages.",
          "Look for odd eyes, lighting, or lips not matching.",
          "Don’t share shocking clips before checking.",
          "Ask an adult if unsure."
        ],
        scenario: {
          prompt: "A video shows your favorite creator saying something rude. It looks a bit off. What do you do?",
          choices: [
            { text: "Share it fast!", isCorrect: false, feedback: "Wait! It could be fake. Don’t spread it." },
            { text: "Check their official page or a trusted source", isCorrect: true, feedback: "Smart! Verify before sharing." },
            { text: "Comment something mean", isCorrect: false, feedback: "Be kind — ask an adult and verify first." }
          ]
        },
        quiz: [
          { q: "What is a deepfake?", options: ["A fake cookie", "A realistic but fake photo/video made with AI"], answerIndex: 1 },
          { q: "Should you share shocking clips quickly?", options: ["Yes", "No — check first"], answerIndex: 1 },
          { q: "If unsure, you should…", options: ["Ask a trusted adult", "Do nothing"], answerIndex: 0 }
        ]
      },
      {
        id: "social",
        emoji: "📱",
        title: "Smart Social Sharing",
        subtitle: "Share happy, share wisely.",
        tips: [
          "Use private accounts if possible.",
          "Hide personal info from profiles.",
          "Turn off location on posts.",
          "Be kind in comments and messages.",
          "Report fake or rude accounts."
        ],
        scenario: {
          prompt: "An app asks to access your contacts and location to ‘improve experience’. What now?",
          choices: [
            { text: "Allow everything", isCorrect: false, feedback: "Only allow what you need." },
            { text: "Allow only what’s needed or say no", isCorrect: true, feedback: "Nice! Keep your info safe." },
            { text: "Share your password too", isCorrect: false, feedback: "Never share passwords." }
          ]
        },
        quiz: [
          { q: "Which is safer for kids?", options: ["Public account", "Private account"], answerIndex: 1 },
          { q: "Share location on posts?", options: ["Yes, always", "Only if needed (or keep off)"], answerIndex: 1 },
          { q: "If someone is rude you should…", options: ["Be rude back", "Block, report, and tell an adult"], answerIndex: 1 }
        ]
      },
      {
        id: "devices",
        emoji: "🔧",
        title: "Device & Wi‑Fi Safety",
        subtitle: "Keep tech healthy and safe.",
        tips: [
          "Update apps and system often.",
          "Use secure Wi‑Fi (avoid unknown public Wi‑Fi).",
          "Don’t install random files.",
          "Use PIN/biometrics to lock your device.",
          "Ask an adult before changing settings."
        ],
        scenario: {
          prompt: "You’re on free public Wi‑Fi. A site asks for your login. What do you do?",
          choices: [
            { text: "Log in now", isCorrect: false, feedback: "Public Wi‑Fi can be risky. Avoid logging in there." },
            { text: "Wait and log in at home or on mobile data", isCorrect: true, feedback: "Great choice — stay safe!" },
            { text: "Download a random ‘security’ app", isCorrect: false, feedback: "Only install trusted apps." }
          ]
        },
        quiz: [
          { q: "What should you do with updates?", options: ["Ignore them", "Install them"], answerIndex: 1 },
          { q: "Public Wi‑Fi is…", options: ["Always safe", "Risky — avoid logins"], answerIndex: 1 },
          { q: "Best way to lock a phone:", options: ["No lock", "PIN/biometrics"], answerIndex: 1 }
        ]
      }
    ];

    // Render modules list
    function renderModules() {
      const wrap = $('#modules');
      wrap.innerHTML = '';
      LESSONS.forEach(m => {
        const card = document.createElement('button');
        card.className = 'card reveal';
        card.setAttribute('role', 'listitem');
        card.innerHTML = `
          <h3>${m.emoji} ${m.title}</h3>
          <p class="muted">${m.subtitle}</p>
          <div class="tiny" aria-hidden="true">${m.tips.slice(0,3).map(t => '• ' + t).join('<br>')}</div>
        `;
        io.observe(card);
        card.addEventListener('click', () => openModule(m.id));
        wrap.appendChild(card);
      });
      updateProgress();
    }

    // Open a module
    function openModule(id) {
      const m = LESSONS.find(x => x.id === id);
      const box = $('#module-detail');
      if (!m) return;
      box.hidden = false;
      window.location.hash = `#module-${id}`;
      const completed = completedModules.has(id);
      box.innerHTML = `
        <div>
          <h3>${m.emoji} ${m.title}</h3>
          <p class="muted">${m.subtitle}</p>
        </div>
        <div class="tips">
          <h4>Top Tips</h4>
          <ul>${m.tips.map(t => `<li>${t}</li>`).join('')}</ul>
        </div>
        <div class="scenario">
          <h4>Try a Scenario</h4>
          <p>${m.scenario.prompt}</p>
          <div class="scenario-actions">
            ${m.scenario.choices.map((c, i) =>
              `<button class="nav-btn" data-choice="${i}">${c.text}</button>`
            ).join('')}
          </div>
          <p id="scenario-feedback" class="muted" aria-live="polite"></p>
        </div>
        <div class="quiz">
          <h4>Quick Quiz</h4>
          <form id="quiz-${id}">
            ${m.quiz.map((q, qi) => `
              <fieldset>
                <legend>${qi + 1}. ${q.q}</legend>
                ${q.options.map((opt, oi) => `
                  <label><input type="radio" name="q${qi}" value="${oi}" required /> ${opt}</label><br>
                `).join('')}
              </fieldset>
            `).join('')}
            <button type="submit" class="cta">Check Answers</button>
          </form>
          <p id="quiz-result" class="muted" aria-live="polite"></p>
        </div>
        <div class="tiny">${completed ? '✅ Quiz completed — star awarded!' : ''}</div>
      `;

      $$('.scenario-actions button', box).forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.dataset.choice);
          const choice = m.scenario.choices[idx];
          const fb = $('#scenario-feedback', box);
          fb.textContent = choice.feedback;
        });
      });

      const form = $(`#quiz-${id}`, box);
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = new FormData(form);
        let correct = 0;
        m.quiz.forEach((q, qi) => {
          const v = data.get(`q${qi}`);
          if (v !== null && Number(v) === q.answerIndex) correct++;
        });
        const result = $('#quiz-result', box);
        if (correct === m.quiz.length) {
          result.textContent = `Great job! You got ${correct}/${m.quiz.length} 🎉`;
          if (!completedModules.has(id)) {
            completedModules.add(id);
            localStorage.setItem('ss-completed', JSON.stringify([...completedModules]));
            updateStarCount();
            fireConfetti();
            updateProgress();
          }
        } else {
          result.textContent = `You got ${correct}/${m.quiz.length}. Try again — you can do it! 💪`;
        }
      });
    }

    // Progress & stars
    function updateStarCount() {
      $('#star-count').textContent = String(completedModules.size);
    }
    function updateProgress() {
      const done = completedModules.size;
      const total = LESSONS.length;
      const pct = Math.round((done / total) * 100);
      const ring = $('#progress-ring');
      const txt = $('#progress-text');
      ring.style.setProperty('--angle', pct + '%');
      txt.textContent = pct + '%';
    }

    // Confetti stars
    function fireConfetti() {
      const wrap = $('#confetti');
      for (let i = 0; i < 26; i++) {
        const star = document.createElement('div');
        star.className = 'confetti-star';
        star.textContent = ['⭐','✨','🌟'][Math.floor(Math.random()*3)];
        star.style.left = Math.random() * 100 + 'vw';
        star.style.top = '-10px';
        star.style.animationDelay = (Math.random() * 0.6) + 's';
        star.style.transform = `scale(${0.7 + Math.random() * 0.8})`;
        wrap.appendChild(star);
        setTimeout(() => star.remove(), 2200);
      }
    }

    // ===== Chat (Ask Spark) — unchanged backend call =====
    const chatLog = $('#chat-log');
    const chatForm = $('#chat-form');
    const chatInput = $('#chat-input');
    $$('input[name="age"]').forEach(r => r.addEventListener('change', () => { ageGroup = r.value; }));

    // PII detection (fixed phone regex)
    function containsPII(t) {
      const email = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i;
      const phone = /(\+?\d{1,2}[\s.-]?)?(KATEX_INLINE_OPEN?\d{3}KATEX_INLINE_CLOSE?[\s.-]?)\d{3}[\s.-]?\d{4}\b/;
      const address = /\b\d{1,5}\s+\w+(?:\s+\w+){0,3}\s+(street|st|avenue|ave|road|rd|boulevard|blvd|lane|ln|drive|dr|court|ct)\b/i;
      const school = /\b(school|elementary|middle\s+school|high\s+school|academy|ps\s?\d+)\b/i;
      const password = /\bpassword\b\s*[:=]\s*\S+/i;
      const username = /\b(user(name)?|login)\b\s*[:=]\s*\S+/i;
      return email.test(t) || phone.test(t) || address.test(t) || school.test(t) || password.test(t) || username.test(t);
    }

    function addUser(text) {
      const b = document.createElement('div');
      b.className = 'chat-bubble user';
      b.textContent = text;
      chatLog.appendChild(b);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    function addSpark(text) {
      const b = document.createElement('div');
      b.className = 'chat-bubble spark';
      b.textContent = text;
      chatLog.appendChild(b);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    function addTyping() {
      const b = document.createElement('div');
      b.className = 'chat-bubble spark';
      b.innerHTML = '<span class="typing-dots"><span></span><span></span><span></span></span>';
      b.dataset.typing = '1';
      chatLog.appendChild(b);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    function removeTyping() {
      const last = Array.from(chatLog.querySelectorAll('.chat-bubble.spark')).reverse().find(x => x.dataset.typing === '1');
      if (last) last.remove();
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      if (containsPII(text)) {
        addSpark("Let’s keep personal info private 👍 Please don’t share your real name, address, phone number, school, email, or passwords. You can ask me about staying safe online, like passwords, privacy, bullying, or games! 🌟");
        chatInput.value = '';
        return;
      }

      addUser(text);
      chatInput.value = '';
      addTyping();

      try {
        const res = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, ageGroup })
        });
        const data = await res.json();
        removeTyping();
        if (data.ok) addSpark(data.reply || 'Thanks for your message! 😊');
        else addSpark(data.error || 'Oops, I had trouble replying. Please try again.');
      } catch {
        removeTyping();
        addSpark('Network error. Please try again in a moment.');
      }
    });

    // ===== Init =====
    strings = STRINGS.en;
    applyStrings();
    renderModules();
    updateStarCount();
  </script>
</body>
</html>
