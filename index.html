<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeSurf Kids ‚Ä¢ Single File</title>
  <meta name="description" content="SafeSurf Kids helps children learn how to stay safe with ICT ‚Äî friendly lessons, quick quizzes, and Spark the AI helper." />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --mint: #06D6A0;
      --blue: #118AB2;
      --yellow: #FFD166;
      --pink: #EF476F;
      --purple: #8E63D1;
      --ink: #173043;
      --bg: #f7fbff;
      --card: #ffffff;
      --muted: #527288;

      --radius: 14px;
      --shadow: 0 8px 24px rgba(17, 138, 178, 0.15);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.4;
    }
    .visually-hidden {
      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden; clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap; border: 0; padding: 0; margin: -1px;
    }
    .site-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: linear-gradient(135deg, var(--mint), var(--blue));
      color: white;
    }
    .brand { display: flex; align-items: center; gap: 14px; }
    .logo { width: 48px; height: 48px; }
    .title { margin: 0; font-weight: 800; letter-spacing: 0.2px; }
    .tagline { margin: 2px 0 0; opacity: 0.95; font-weight: 600; }
    .header-actions { display: flex; gap: 16px; align-items: center; }
    .achievements {
      background: rgba(255, 255, 255, 0.15);
      padding: 8px 12px; border-radius: 999px;
      display: flex; gap: 8px; align-items: center;
    }
    .star { font-size: 18px; }
    .lang-toggle select {
      border: none; border-radius: 999px; padding: 8px 12px;
      background: white; color: var(--ink); font-weight: 700;
    }
    .main-nav {
      display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 16px;
      background: #fff; box-shadow: var(--shadow);
    }
    .nav-btn {
      background: var(--yellow); border: 0; border-radius: 999px; padding: 10px 16px;
      font-weight: 800; color: var(--ink); cursor: pointer;
      transition: transform 0.06s ease, background 0.2s ease;
    }
    .nav-btn:hover { transform: translateY(-2px); }
    .nav-btn:focus-visible { outline: 3px solid var(--purple); }
    .nav-btn.active { background: var(--mint); color: #083d2f; }
    main { padding: 20px 16px 80px; max-width: 1100px; margin: 0 auto; }
    .view { display: none; }
    .view.active { display: block; }
    .hero {
      background: linear-gradient(135deg, #fff, #f6fff9);
      border-radius: var(--radius); box-shadow: var(--shadow); padding: 24px;
    }
    .hero-actions { display: flex; gap: 12px; margin-top: 10px; }
    .cta {
      display: inline-block; background: var(--pink); color: white;
      padding: 12px 18px; border-radius: 12px; text-decoration: none;
      font-weight: 800; transition: transform 0.06s ease, opacity 0.2s ease;
    }
    .cta:hover { transform: translateY(-2px); opacity: 0.95; }
    .cta.secondary { background: var(--blue); }
    .quick-cards {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px; margin-top: 16px;
    }
    .card {
      background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 16px; transition: transform 0.06s ease, box-shadow 0.2s ease;
      text-align: left;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(17, 138, 178, 0.25); }
    .modules {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px; margin-top: 16px;
    }
    .module-detail {
      background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 18px; margin-top: 16px;
    }
    .muted { color: var(--muted); }
    .tiny { font-size: 0.9rem; }

    /* Chat */
    .safety-banner {
      background: #fff3c9; border: 2px dashed var(--yellow);
      padding: 12px; border-radius: 12px; margin-bottom: 12px; font-weight: 800;
    }
    .age-toggle { display: flex; gap: 16px; margin-bottom: 8px; align-items: center; font-weight: 700; }
    .chat { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .chat-log {
      max-height: 380px; min-height: 220px; overflow: auto; padding: 16px;
      background: linear-gradient(180deg, #fdfdff, #f5fbff);
    }
    .chat-bubble { display: inline-block; padding: 10px 12px; border-radius: 14px; margin: 8px 0; max-width: 80%; line-height: 1.45; }
    .chat-bubble.user { background: var(--blue); color: white; border-bottom-right-radius: 4px; }
    .chat-bubble.spark { background: #eefcf6; border: 2px solid var(--mint); color: #0b5a49; border-bottom-left-radius: 4px; }
    .chat-form { display: flex; gap: 10px; border-top: 1px solid #e7eef5; padding: 12px; }
    .chat-form input[type="text"] { flex: 1; padding: 12px 14px; border-radius: 12px; border: 2px solid #d6e5f2; font-size: 1rem; }
    .chat-form input:focus-visible { outline: none; border-color: var(--purple); }
    .send-btn { background: var(--mint); color: #083d2f; border: 0; border-radius: 12px; font-weight: 800; padding: 12px 16px; cursor: pointer; }
    .send-btn:hover { filter: brightness(0.95); }

    .parent-grid, .resources-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .site-footer { text-align: center; color: var(--muted); padding: 24px 16px; }

    button, a, input, select { transition: transform 0.05s ease, box-shadow 0.2s ease, background 0.2s ease; }
    button:active, a:active { transform: translateY(1px); }

    /* Confetti emoji stars */
    #confetti { pointer-events: none; position: fixed; inset: 0; }
    .confetti-star {
      position: absolute; font-size: 18px; line-height: 1;
      animation: floatDown 1.8s ease-out forwards;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.12));
    }
    @keyframes floatDown {
      0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
      15% { opacity: 1; }
      100% { transform: translateY(90vh) rotate(260deg); opacity: 0; }
    }

    @media (max-width: 720px) {
      .site-header { align-items: flex-start; gap: 10px; }
      .brand { gap: 10px; }
      .title { font-size: 1.2rem; }
      .tagline { font-size: 0.95rem; }
    }
  </style>
</head>
<body>
  <header class="site-header" role="banner">
    <div class="brand">
      <!-- Inline logo -->
      <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96" aria-hidden="true" focusable="false">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#06D6A0"/>
            <stop offset="100%" stop-color="#118AB2"/>
          </linearGradient>
        </defs>
        <circle cx="48" cy="48" r="44" fill="url(#g)"></circle>
        <path d="M48 18c14 8 22 10 32 12-1 20-7 34-32 48-25-14-31-28-32-48 10-2 18-4 32-12z" fill="#fff" opacity="0.9"/>
        <path d="M35 49l8 8 18-18" stroke="#06D6A0" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div>
        <h1 id="app-title" class="title" data-i18n="app.title">SafeSurf Kids</h1>
        <p class="tagline" data-i18n="app.tagline">Learn to stay safe online with Spark! ‚ú®</p>
      </div>
    </div>

    <div class="header-actions">
      <div class="achievements" aria-live="polite">
        <span class="star">‚≠ê</span>
        <span data-i18n="app.stars">Stars:</span>
        <strong id="star-count">0</strong>
      </div>

      <div class="lang-toggle" aria-label="Language">
        <label for="lang-select" class="visually-hidden">Language</label>
        <select id="lang-select" aria-label="Language select">
          <option value="en" selected>English</option>
          <option value="es">Espa√±ol</option>
        </select>
      </div>
    </div>
  </header>

  <nav class="main-nav" role="navigation" aria-label="Main">
    <button class="nav-btn active" data-target="home" data-i18n="nav.home">Home</button>
    <button class="nav-btn" data-target="learn" data-i18n="nav.learn">Learn</button>
    <button class="nav-btn" data-target="ask" data-i18n="nav.ask">Ask Spark</button>
    <button class="nav-btn" data-target="parents" data-i18n="nav.parents">Parent & Carer Corner</button>
    <button class="nav-btn" data-target="resources" data-i18n="nav.resources">Resources</button>
  </nav>

  <main>
    <!-- Home -->
    <section id="home" class="view active" aria-labelledby="home-heading">
      <div class="hero">
        <h2 id="home-heading" data-i18n="home.heading">Welcome! üåà</h2>
        <p data-i18n="home.sub">Let‚Äôs learn how to be safe and kind with ICT ‚Äî on the internet, in apps, and games.</p>
        <div class="hero-actions">
          <a href="#learn" class="cta" data-nav="learn" data-i18n="home.startLearning">Start Learning</a>
          <a href="#ask" class="cta secondary" data-nav="ask" data-i18n="home.askSpark">Ask the AI</a>
        </div>
      </div>

      <div class="quick-cards" role="list">
        <div class="card" role="listitem" tabindex="0">
          <h3>üîê Strong Passwords</h3>
          <p>Use long, secret passwords. Turn on 2FA!</p>
        </div>
        <div class="card" role="listitem" tabindex="0">
          <h3>üõ°Ô∏è Privacy & Sharing</h3>
          <p>Think before you post. Keep personal info private.</p>
        </div>
        <div class="card" role="listitem" tabindex="0">
          <h3>üí¨ Be Kind Online</h3>
          <p>Report bullying. Save messages. Talk to an adult.</p>
        </div>
        <div class="card" role="listitem" tabindex="0">
          <h3>üéÆ Gaming Safety</h3>
          <p>Use safe chats. Watch in‚Äëapp purchases. Take breaks!</p>
        </div>
      </div>
    </section>

    <!-- Learn -->
    <section id="learn" class="view" aria-labelledby="learn-heading">
      <h2 id="learn-heading" data-i18n="learn.heading">Learn: Safety Modules</h2>
      <p class="muted" data-i18n="learn.desc">Tap a card to read tips, try a scenario, and take a quick quiz.</p>
      <div id="modules" class="modules" role="list"></div>
      <div id="module-detail" class="module-detail" hidden aria-live="polite"></div>
    </section>

    <!-- Ask Spark (AI chat) -->
    <section id="ask" class="view" aria-labelledby="ask-heading">
      <h2 id="ask-heading" data-i18n="ask.heading">Ask Spark (AI)</h2>
      <div class="safety-banner" role="note" data-i18n="ask.banner">
        Never share your real name, address, phone, school, or passwords.
      </div>

      <div class="age-toggle" role="group" aria-label="Age group">
        <label><input type="radio" name="age" value="8-10" checked /> 8‚Äì10</label>
        <label><input type="radio" name="age" value="11-13" /> 11‚Äì13</label>
      </div>

      <div class="chat" aria-label="Chat with Spark">
        <div id="chat-log" class="chat-log" role="log" aria-live="polite" aria-relevant="additions"></div>

        <form id="chat-form" class="chat-form" autocomplete="off">
          <label for="chat-input" class="visually-hidden">Your message</label>
          <input
            id="chat-input"
            name="message"
            type="text"
            minlength="1"
            maxlength="600"
            placeholder="Ask me about staying safe online!"
            aria-label="Ask me about staying safe online!"
            required
          />
          <button type="submit" class="send-btn">Send</button>
        </form>
        <p class="tiny muted" data-i18n="ask.footer">We don‚Äôt store chats. Be kind and keep info private.</p>
      </div>
      <p class="tiny muted" style="margin-top:8px">
        Single-file mode uses friendly local replies. To use your real AI backend later, set USE_BACKEND = true in the script and host with the Node server.
      </p>
    </section>

    <!-- Parent & Carer Corner -->
    <section id="parents" class="view" aria-labelledby="parents-heading">
      <h2 id="parents-heading" data-i18n="parents.heading">Parent & Carer Corner</h2>
      <div class="parent-grid">
        <article class="card">
          <h3 data-i18n="parents.tipsTitle">Quick Tips</h3>
          <ul>
            <li data-i18n="parents.tip1">Talk early and often about online kindness and privacy.</li>
            <li data-i18n="parents.tip2">Set clear rules together (bedtime, screens out of bedrooms).</li>
            <li data-i18n="parents.tip3">Use family accounts and turn on parental controls where helpful.</li>
            <li data-i18n="parents.tip4">Learn the games and apps they use; play together sometimes.</li>
            <li data-i18n="parents.tip5">Keep devices updated; use strong passwords & 2FA.</li>
          </ul>
        </article>
        <article class="card">
          <h3 data-i18n="parents.startersTitle">Conversation Starters</h3>
          <ul>
            <li data-i18n="parents.start1">How do you decide what to share online?</li>
            <li data-i18n="parents.start2">What would you do if someone was unkind or asked for private info?</li>
            <li data-i18n="parents.start3">Which games or creators make you feel good? Why?</li>
          </ul>
        </article>
        <article class="card">
          <h3 data-i18n="parents.signsTitle">Signs to Watch For</h3>
          <ul>
            <li data-i18n="parents.sign1">Sudden worry about going online or changes in mood.</li>
            <li data-i18n="parents.sign2">Secret new accounts or hiding screens.</li>
            <li data-i18n="parents.sign3">Unexplained charges or new ‚Äúfriends.‚Äù</li>
          </ul>
        </article>
        <article class="card">
          <h3 data-i18n="parents.controlsTitle">Parental Controls Basics</h3>
          <p data-i18n="parents.controlsDesc">Use built‚Äëin tools on devices, consoles, and routers to filter content, set time limits, and restrict purchases. Review settings together so kids understand why.</p>
        </article>
      </div>
    </section>

    <!-- Resources -->
    <section id="resources" class="view" aria-labelledby="resources-heading">
      <h2 id="resources-heading" data-i18n="resources.heading">Resources</h2>
      <div class="resources-grid">
        <article class="card">
          <h3 data-i18n="resources.helpTitle">If you need help</h3>
          <ul>
            <li data-i18n="resources.help1">Talk to a trusted adult (parent, carer, teacher, counselor).</li>
            <li data-i18n="resources.help2">If you are in danger, contact local emergency services right away.</li>
            <li data-i18n="resources.help3">Use app/game ‚ÄúReport‚Äù and ‚ÄúBlock‚Äù features when needed.</li>
          </ul>
        </article>
        <article class="card">
          <h3 data-i18n="resources.linksTitle">Helpful links</h3>
          <ul class="links">
            <li><a href="https://www.childline.org.uk" target="_blank" rel="noopener">Childline (UK)</a></li>
            <li><a href="https://www.kidshelpphone.ca" target="_blank" rel="noopener">Kids Help Phone (CA)</a></li>
            <li><a href="https://www.stopbullying.gov" target="_blank" rel="noopener">StopBullying.gov (US)</a></li>
            <li><a href="https://www.commonsensemedia.org" target="_blank" rel="noopener">Common Sense Media</a></li>
          </ul>
          <p class="tiny muted" data-i18n="resources.note">Links are examples ‚Äî find local resources for your area.</p>
        </article>
      </div>
    </section>
  </main>

  <div id="confetti" aria-hidden="true"></div>

  <footer class="site-footer">
    <p>¬© <span id="year"></span> SafeSurf Kids ¬∑ <span class="tiny" data-i18n="footer.privacy">We don‚Äôt collect personal data.</span></p>
  </footer>

  <script>
    // ===== Config =====
    // By default this single-file uses local friendly replies for Spark.
    // To connect a real backend later (Express /api/ask), set USE_BACKEND = true
    // and host this file from the same origin as your server.
    const USE_BACKEND = false;
    const BACKEND_URL = '/api/ask'; // only works when hosted with the Node server

    // ===== Utilities & State =====
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

    let strings = {};
    let lang = 'en';
    let completedModules = new Set(JSON.parse(localStorage.getItem('ss-completed') || '[]'));
    let ageGroup = '8-10';

    // Year in footer
    $('#year').textContent = new Date().getFullYear();

    // Nav handling
    $$('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target;
        showView(target);
        $$('.nav-btn').forEach(b => b.classList.toggle('active', b === btn));
      });
    });
    $$('[data-nav="learn"]').forEach(a => a.addEventListener('click', e => {
      e.preventDefault(); $('[data-target="learn"]').click();
    }));
    $$('[data-nav="ask"]').forEach(a => a.addEventListener('click', e => {
      e.preventDefault(); $('[data-target="ask"]').click();
    }));

    function showView(id) {
      $$('.view').forEach(v => v.classList.toggle('active', v.id === id));
      if (id === 'learn') window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ===== Localization =====
    const STRINGS = {
      en: {
        app: { title: "SafeSurf Kids", tagline: "Learn to stay safe online with Spark! ‚ú®", stars: "Stars:" },
        nav: { home: "Home", learn: "Learn", ask: "Ask Spark", parents: "Parent & Carer Corner", resources: "Resources" },
        home: { heading: "Welcome! üåà", sub: "Let‚Äôs learn how to be safe and kind with ICT ‚Äî on the internet, in apps, and games.", startLearning: "Start Learning", askSpark: "Ask the AI" },
        learn: { heading: "Learn: Safety Modules", desc: "Tap a card to read tips, try a scenario, and take a quick quiz." },
        ask: { heading: "Ask Spark (AI)", banner: "Never share your real name, address, phone, school, or passwords.", footer: "We don‚Äôt store chats. Be kind and keep info private." },
        parents: {
          heading: "Parent & Carer Corner", tipsTitle: "Quick Tips",
          tip1: "Talk early and often about online kindness and privacy.",
          tip2: "Set clear rules together (bedtime, screens out of bedrooms).",
          tip3: "Use family accounts and turn on parental controls where helpful.",
          tip4: "Learn the games and apps they use; play together sometimes.",
          tip5: "Keep devices updated; use strong passwords & 2FA.",
          startersTitle: "Conversation Starters",
          start1: "How do you decide what to share online?",
          start2: "What would you do if someone was unkind or asked for private info?",
          start3: "Which games or creators make you feel good? Why?",
          signsTitle: "Signs to Watch For",
          sign1: "Sudden worry about going online or changes in mood.",
          sign2: "Secret new accounts or hiding screens.",
          sign3: "Unexplained charges or new ‚Äúfriends.‚Äù",
          controlsTitle: "Parental Controls Basics",
          controlsDesc: "Use built‚Äëin tools on devices, consoles, and routers to filter content, set time limits, and restrict purchases. Review settings together so kids understand why."
        },
        resources: {
          heading: "Resources",
          helpTitle: "If you need help",
          help1: "Talk to a trusted adult (parent, carer, teacher, counselor).",
          help2: "If you are in danger, contact local emergency services right away.",
          help3: "Use app/game ‚ÄúReport‚Äù and ‚ÄúBlock‚Äù features when needed.",
          linksTitle: "Helpful links",
          note: "Links are examples ‚Äî find local resources for your area."
        },
        footer: { privacy: "We don‚Äôt collect personal data." }
      },
      es: {
        app: { title: "SafeSurf Kids", tagline: "¬°Aprende a estar seguro en l√≠nea con Spark! ‚ú®", stars: "Estrellas:" },
        nav: { home: "Inicio", learn: "Aprender", ask: "Preguntar a Spark", parents: "Para familias y cuidadores", resources: "Recursos" },
        home: { heading: "¬°Bienvenid@! üåà", sub: "Aprendamos a ser seguros y amables con las TIC ‚Äî en internet, apps y juegos.", startLearning: "Comenzar", askSpark: "Preguntar a la IA" },
        learn: { heading: "Aprender: M√≥dulos de seguridad", desc: "Toca una tarjeta para leer consejos, probar un escenario y hacer un mini cuestionario." },
        ask: { heading: "Pregunta a Spark (IA)", banner: "Nunca compartas tu nombre real, direcci√≥n, tel√©fono, escuela ni contrase√±as.", footer: "No guardamos los chats. S√© amable y cuida tu privacidad." },
        parents: {
          heading: "Para familias y cuidadores", tipsTitle: "Consejos r√°pidos",
          tip1: "Hablen temprano y con frecuencia sobre amabilidad y privacidad.",
          tip2: "Acordar reglas claras (hora de dormir, sin pantallas en el dormitorio).",
          tip3: "Usar cuentas familiares y controles parentales cuando ayuden.",
          tip4: "Conozcan los juegos y apps que usan; jueguen juntos a veces.",
          tip5: "Mantener dispositivos actualizados; contrase√±as fuertes y 2FA.",
          startersTitle: "Para conversar",
          start1: "¬øC√≥mo decides qu√© compartir en l√≠nea?",
          start2: "¬øQu√© har√≠as si alguien es agresivo o pide info privada?",
          start3: "¬øQu√© juegos o creadores te hacen sentir bien? ¬øPor qu√©?",
          signsTitle: "Se√±ales a observar",
          sign1: "Preocupaci√≥n por conectarse o cambios de √°nimo.",
          sign2: "Cuentas nuevas secretas u ocultar la pantalla.",
          sign3: "Cargos extra√±os o ‚Äúamigos‚Äù nuevos.",
          controlsTitle: "Controles parentales b√°sicos",
          controlsDesc: "Usa herramientas en dispositivos, consolas y routers para filtrar contenido, limitar tiempo y restringir compras. Revisen ajustes juntos para entender el porqu√©."
        },
        resources: {
          heading: "Recursos",
          helpTitle: "Si necesitas ayuda",
          help1: "Habla con un adulto de confianza (madre/padre, cuidador, profesor, orientador).",
          help2: "Si est√°s en peligro, contacta a los servicios de emergencia locales.",
          help3: "Usa ‚ÄúReportar‚Äù y ‚ÄúBloquear‚Äù en las apps/juegos cuando haga falta.",
          linksTitle: "Enlaces √∫tiles",
          note: "Los enlaces son ejemplos ‚Äî busca recursos locales de tu zona."
        },
        footer: { privacy: "No recopilamos datos personales." }
      }
    };

    function applyStrings() {
      $$('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        const val = key.split('.').reduce((acc, k) => acc && acc[k], strings);
        if (typeof val === 'string') el.textContent = val;
      });
    }
    $('#lang-select').addEventListener('change', (e) => {
      lang = e.target.value;
      strings = STRINGS[lang] || STRINGS.en;
      applyStrings();
    });

    // ===== Lessons Data =====
    const LESSONS = [
      {
        "id": "passwords",
        "emoji": "üîê",
        "title": "Strong Passwords & 2FA",
        "subtitle": "Make your accounts tough to crack!",
        "tips": [
          "Use long passwords (12+). Try three random words.",
          "Never share passwords with friends.",
          "Use a different password for each account.",
          "Turn on 2FA ‚Äî a code from an app or text.",
          "Keep devices locked with a PIN or passcode."
        ],
        "scenario": {
          "prompt": "A message says: ‚ÄúYour account is locked! Send your password to fix it.‚Äù What do you do?",
          "choices": [
            { "text": "Send my password to unlock it", "isCorrect": false, "feedback": "Nope! Never share passwords. This is likely a scam." },
            { "text": "Ignore and go to the official app/website", "isCorrect": true, "feedback": "Yes! Use the real app/website and change your password if worried." },
            { "text": "Ask friends if they got the same message", "isCorrect": false, "feedback": "Better to check the official site instead of asking friends." }
          ]
        },
        "quiz": [
          { "q": "What makes a strong password?", "options": ["Your name + birthday", "12+ characters with random words", "12345678"], "answerIndex": 1 },
          { "q": "What is 2FA?", "options": ["A gaming level", "A code to prove it‚Äôs you", "An emoji"], "answerIndex": 1 },
          { "q": "Should you share passwords?", "options": ["Yes", "No"], "answerIndex": 1 }
        ]
      },
      {
        "id": "privacy",
        "emoji": "üõ°Ô∏è",
        "title": "Privacy & Sharing",
        "subtitle": "Think before you post.",
        "tips": [
          "Keep real name, address, phone, and school private.",
          "Turn off location sharing in apps you don‚Äôt trust.",
          "Check privacy settings for posts and profiles.",
          "Ask before sharing photos of friends.",
          "Post kindly ‚Äî your future self will thank you!"
        ],
        "scenario": {
          "prompt": "A new friend asks for your address to send a gift. What do you do?",
          "choices": [
            { "text": "Share it in chat", "isCorrect": false, "feedback": "Not safe. Never share your home address online." },
            { "text": "Say no and ask a trusted adult", "isCorrect": true, "feedback": "Great choice! Keep private info safe and talk to an adult." },
            { "text": "Give a nearby place instead", "isCorrect": false, "feedback": "Still risky. Don‚Äôt share locations online." }
          ]
        },
        "quiz": [
          { "q": "What info should stay private?", "options": ["Real name & address", "Favorite color"], "answerIndex": 0 },
          { "q": "Who should you ask before posting a group photo?", "options": ["No one", "The people in the photo"], "answerIndex": 1 },
          { "q": "What should you do with location sharing?", "options": ["Leave it on always", "Turn it off unless needed"], "answerIndex": 1 }
        ]
      },
      {
        "id": "cyberbullying",
        "emoji": "üí¨",
        "title": "Cyberbullying",
        "subtitle": "Be kind, block, and report.",
        "tips": [
          "If someone is unkind, don‚Äôt reply. Save evidence.",
          "Use block and report. It‚Äôs not tattling ‚Äî it‚Äôs safety.",
          "Talk to a trusted adult right away.",
          "Be kind when you comment and message.",
          "Check in on friends who seem down."
        ],
        "scenario": {
          "prompt": "Someone keeps sending mean messages in a group chat. What now?",
          "choices": [
            { "text": "Send mean messages back", "isCorrect": false, "feedback": "This can make it worse. Don‚Äôt reply." },
            { "text": "Block, report, and tell a trusted adult", "isCorrect": true, "feedback": "That‚Äôs right! Block/report and talk to an adult." },
            { "text": "Leave the group and never tell anyone", "isCorrect": false, "feedback": "Leaving can help, but also tell a trusted adult." }
          ]
        },
        "quiz": [
          { "q": "What should you keep as evidence?", "options": ["Screenshots", "Nothing"], "answerIndex": 0 },
          { "q": "Who can you talk to?", "options": ["A trusted adult", "No one"], "answerIndex": 0 },
          { "q": "What can apps help you do?", "options": ["Block and report", "Send mean messages"], "answerIndex": 0 }
        ]
      },
      {
        "id": "scams",
        "emoji": "üïµÔ∏è",
        "title": "Scams & Phishing",
        "subtitle": "Spot tricks before they get you.",
        "tips": [
          "Don‚Äôt click strange links or attachments.",
          "Check the sender‚Äôs address ‚Äî fakes look similar.",
          "Look for spelling mistakes and urgent threats.",
          "Use the official website or app to check your account.",
          "Ask an adult if anything feels off."
        ],
        "scenario": {
          "prompt": "You win a ‚Äúfree phone‚Äù if you click a link. It asks for your login. What now?",
          "choices": [
            { "text": "Enter my login to get the prize", "isCorrect": false, "feedback": "This is a phishing trick. Don‚Äôt share logins." },
            { "text": "Close it and tell a trusted adult", "isCorrect": true, "feedback": "Good move! Stay safe and double-check with an adult." },
            { "text": "Click the link but don‚Äôt type anything", "isCorrect": false, "feedback": "Even clicking can be risky. Better to close it." }
          ]
        },
        "quiz": [
          { "q": "Which looks suspicious?", "options": ["Urgent prizes & weird links", "A message from your parent"], "answerIndex": 0 },
          { "q": "Where should you check your account?", "options": ["Official app/website", "Random link"], "answerIndex": 0 },
          { "q": "Who can help if unsure?", "options": ["A trusted adult", "A stranger online"], "answerIndex": 0 }
        ]
      },
      {
        "id": "gaming",
        "emoji": "üéÆ",
        "title": "Gaming Safety & Screen Time",
        "subtitle": "Play fun, play fair, take breaks.",
        "tips": [
          "Use family-friendly chats and block rude players.",
          "Ask before buying in-game items.",
          "Take eye-and-body breaks every 30‚Äì60 mins.",
          "Don‚Äôt share private info in voice chat.",
          "Balance games with sleep, school, and friends."
        ],
        "scenario": {
          "prompt": "A player asks for your login to ‚Äòboost‚Äô your account. What do you do?",
          "choices": [
            { "text": "Share it ‚Äî I want better items", "isCorrect": false, "feedback": "Nope! Never share logins. They could steal your account." },
            { "text": "Say no, block the player, and report", "isCorrect": true, "feedback": "Perfect. Protect your account and move on." },
            { "text": "Share only the password", "isCorrect": false, "feedback": "That‚Äôs the most secret part. Keep it private!" }
          ]
        },
        "quiz": [
          { "q": "How often to take breaks?", "options": ["Every 30‚Äì60 mins", "Never"], "answerIndex": 0 },
          { "q": "What about in-app purchases?", "options": ["Ask a parent/carer first", "Buy anything"], "answerIndex": 0 },
          { "q": "What info should you keep private in voice chat?", "options": ["Your address & school", "Game tips"], "answerIndex": 0 }
        ]
      }
    ];

    function renderModules() {
      const wrap = $('#modules');
      wrap.innerHTML = '';
      LESSONS.forEach(m => {
        const card = document.createElement('button');
        card.className = 'card';
        card.setAttribute('role', 'listitem');
        card.innerHTML = `
          <h3>${m.emoji} ${m.title}</h3>
          <p class="muted">${m.subtitle}</p>
          <div class="tiny" aria-hidden="true">${m.tips.slice(0,3).map(t => '‚Ä¢ ' + t).join('<br>')}</div>
        `;
        card.addEventListener('click', () => openModule(m.id));
        wrap.appendChild(card);
      });
    }

    function openModule(id) {
      const m = LESSONS.find(x => x.id === id);
      const box = $('#module-detail');
      if (!m) return;
      box.hidden = false;
      window.location.hash = `#module-${id}`;
      const completed = completedModules.has(id);
      box.innerHTML = `
        <div>
          <h3>${m.emoji} ${m.title}</h3>
          <p class="muted">${m.subtitle}</p>
        </div>
        <div class="tips">
          <h4>Top Tips</h4>
          <ul>${m.tips.map(t => `<li>${t}</li>`).join('')}</ul>
        </div>
        <div class="scenario">
          <h4>Try a Scenario</h4>
          <p>${m.scenario.prompt}</p>
          <div class="scenario-actions">
            ${m.scenario.choices.map((c, i) =>
              `<button class="nav-btn" data-choice="${i}">${c.text}</button>`
            ).join('')}
          </div>
          <p id="scenario-feedback" class="muted" aria-live="polite"></p>
        </div>
        <div class="quiz">
          <h4>Quick Quiz</h4>
          <form id="quiz-${id}">
            ${m.quiz.map((q, qi) => `
              <fieldset>
                <legend>${qi + 1}. ${q.q}</legend>
                ${q.options.map((opt, oi) => `
                  <label>
                    <input type="radio" name="q${qi}" value="${oi}" required />
                    ${opt}
                  </label><br>
                `).join('')}
              </fieldset>
            `).join('')}
            <button type="submit" class="cta">Check Answers</button>
          </form>
          <p id="quiz-result" class="muted" aria-live="polite"></p>
        </div>
        <div class="tiny">${completed ? '‚úÖ Quiz completed ‚Äî star awarded!' : ''}</div>
      `;

      // Scenario logic
      $$('.scenario-actions button', box).forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.dataset.choice);
          const choice = m.scenario.choices[idx];
          const fb = $('#scenario-feedback', box);
          fb.textContent = choice.feedback;
        });
      });

      // Quiz logic
      const form = $(`#quiz-${id}`, box);
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = new FormData(form);
        let correct = 0;
        m.quiz.forEach((q, qi) => {
          const v = data.get(`q${qi}`);
          if (v !== null && Number(v) === q.answerIndex) correct++;
        });
        const result = $('#quiz-result', box);
        if (correct === m.quiz.length) {
          result.textContent = `Great job! You got ${correct}/${m.quiz.length} üéâ`;
          if (!completedModules.has(id)) {
            completedModules.add(id);
            localStorage.setItem('ss-completed', JSON.stringify([...completedModules]));
            updateStarCount();
            fireConfetti();
          }
        } else {
          result.textContent = `You got ${correct}/${m.quiz.length}. Try again ‚Äî you can do it! üí™`;
        }
      });
    }

    function updateStarCount() {
      $('#star-count').textContent = String(completedModules.size);
    }

    // Confetti stars (emoji)
    function fireConfetti() {
      const wrap = $('#confetti');
      for (let i = 0; i < 20; i++) {
        const star = document.createElement('div');
        star.className = 'confetti-star';
        star.textContent = '‚≠ê';
        star.style.left = Math.random() * 100 + 'vw';
        star.style.top = '-10px';
        star.style.animationDelay = (Math.random() * 0.6) + 's';
        star.style.transform = `scale(${0.7 + Math.random() * 0.8})`;
        wrap.appendChild(star);
        setTimeout(() => star.remove(), 2200);
      }
    }

    // ===== Chat (Ask Spark) =====
    const chatLog = $('#chat-log');
    const chatForm = $('#chat-form');
    const chatInput = $('#chat-input');

    $$('input[name="age"]').forEach(r => {
      r.addEventListener('change', () => { ageGroup = r.value; });
    });

    // Frontend PII detection
    function containsPII(t) {
      const email = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i;
      const phone = /(\+?\d{1,2}[\s.-]?)?(KATEX_INLINE_OPEN?\d{3}KATEX_INLINE_CLOSE?[\s.-]?)\d{3}[\s.-]?\d{4}\b/;
      const address = /\b\d{1,5}\s+\w+(?:\s+\w+){0,3}\s+(street|st|avenue|ave|road|rd|boulevard|blvd|lane|ln|drive|dr|court|ct)\b/i;
      const school = /\b(school|elementary|middle\s+school|high\s+school|academy|ps\s?\d+)\b/i;
      const password = /\bpassword\b\s*[:=]\s*\S+/i;
      const username = /\b(user(name)?|login)\b\s*[:=]\s*\S+/i;
      return email.test(t) || phone.test(t) || address.test(t) || school.test(t) || password.test(t) || username.test(t);
    }
    function addUser(text) {
      const b = document.createElement('div');
      b.className = 'chat-bubble user';
      b.textContent = text;
      chatLog.appendChild(b);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    function addSpark(text) {
      const b = document.createElement('div');
      b.className = 'chat-bubble spark';
      b.textContent = text;
      chatLog.appendChild(b);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    function removeLastSparkTyping() {
      const bubbles = $$('.chat-bubble.spark');
      const last = bubbles[bubbles.length - 1];
      if (last && last.textContent.startsWith('Typing‚Ä¶')) last.remove();
    }

    // Local friendly replies (works offline)
    const canned = [
      { k: /password|2fa|passcode/i,
        t: `Strong passwords are like super shields! üõ°Ô∏è
- Use 3 random words (like "TreeSunnyRocket").
- Make it long (12+).
- Turn on 2FA for a one‚Äëtime code.
You‚Äôve got this! üåü` },
      { k: /scam|phish|link|free|prize/i,
        t: `Scams try to trick you üòï
- Don‚Äôt click weird links or prizes.
- Check using the real app/website.
- Ask a trusted adult if unsure.
Stay sharp, hero! ‚ú®` },
      { k: /bully|mean|harass|unkind/i,
        t: `If someone is unkind online üí¨
- Don‚Äôt reply. Take screenshots.
- Block and report.
- Talk to a trusted adult.
You deserve kindness. üíõ` },
      { k: /game|gaming|chat|voice|purchase/i,
        t: `Gaming safely = more fun üéÆ
- Keep private info secret.
- Block rude players.
- Take breaks every 30‚Äì60 mins.
Nice teamwork! ‚≠ê` }
    ];
    const safeBlockReply =
      "Let‚Äôs keep personal info private üëç Please don‚Äôt share your real name, address, phone number, school, email, or passwords. " +
      "You can ask me about staying safe online, like passwords, privacy, bullying, or games! üåü";

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      if (containsPII(text)) {
        addSpark(safeBlockReply);
        chatInput.value = '';
        return;
      }

      addUser(text);
      chatInput.value = '';
      addSpark('Typing‚Ä¶ ‚åõ');

      // Use backend if enabled, otherwise local canned reply
      if (USE_BACKEND) {
        try {
          const res = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, ageGroup })
          });
          const data = await res.json();
          removeLastSparkTyping();
          if (data.ok) {
            addSpark(data.reply || 'Thanks for your message! üòä');
          } else {
            addSpark(data.error || 'Oops, I had trouble replying. Please try again.');
          }
        } catch (err) {
          removeLastSparkTyping();
          addSpark('Network error. Please try again in a moment.');
        }
      } else {
        // Local friendly reply
        setTimeout(() => {
          removeLastSparkTyping();
          const found = canned.find(c => c.k.test(text));
          const reply = found?.t || `Great question! üåà
- Think before you share.
- Ask a trusted adult if unsure.
- Block/report unkind or scammy stuff.
I‚Äôm cheering for you! ‚≠ê`;
          addSpark(reply);
        }, 500 + Math.random() * 600);
      }
    });

    // ===== Init =====
    strings = STRINGS.en;
    applyStrings();
    renderModules();
    updateStarCount();
  </script>
</body>
</html>
