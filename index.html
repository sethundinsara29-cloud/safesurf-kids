<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeSurf Kids ‚Ä¢ Spark Edition</title>
  <meta name="description" content="SafeSurf Kids: lessons, tools, Spark AI chat, and a runner game to learn safe ICT." />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;700;800;900&display=swap" rel="stylesheet" />
  <style>
    :root{
      --blue:#2563EB;        /* primary blue */
      --blue-dark:#1E40AF;   /* deep blue */
      --sky:#38BDF8;         /* accent blue */
      --ink:#0F172A;         /* main text */
      --muted:#6B7280;       /* muted text */
      --white:#FFFFFF;
      --bg:#FFFFFF;          /* white base */
      --soft:#EFF6FF;        /* soft light-blue surfaces */
      --card:#FFFFFF;
      --shadow:0 16px 44px rgba(2, 6, 23, .10);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0; color:var(--ink);
      font-family:'Nunito',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1100px 650px at -10% -20%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(900px 600px at 110% -10%, rgba(37,99,235,.10), transparent 55%),
        var(--bg);
      line-height:1.45; scroll-behavior:smooth;
    }

    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;padding:0;margin:-1px}

    /* Header (centered brand + icon) */
    header.site-header{
      position:sticky; top:0; z-index:1000; background:var(--white);
      border-bottom:4px solid var(--sky);
      box-shadow:0 10px 26px rgba(2,6,23,.06);
    }
    .bar{
      display:grid; grid-template-columns:1fr; row-gap:10px;
      align-items:center; justify-items:center; padding:14px 16px;
      text-align:center;
    }
    .brand{display:flex; flex-direction:column; align-items:center; gap:10px}
    .logo{
      width:64px; height:64px; filter:drop-shadow(0 10px 18px rgba(37,99,235,.30));
      animation:float 4.8s ease-in-out infinite; transform-origin:50% 50%;
    }
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(4px)}}
    .title{margin:0;font-weight:900;letter-spacing:.3px}
    .tagline{margin:2px 0 0;color:var(--muted);font-weight:800}

    .actions{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:center
    }
    .progress{
      display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;
      background:#E0EAFF;border:2px solid #C7D2FE;font-weight:900;color:#0B255F
    }
    .ring{
      --size:46px;width:var(--size);height:var(--size);border-radius:50%;
      background:
        conic-gradient(var(--blue) var(--angle,0%), rgba(255,255,255,.7) 0),
        radial-gradient(circle at 50% 50%, #fff 64%, transparent 66%);
      display:grid;place-items:center;font-size:12px;color:#0B255F;box-shadow:inset 0 0 0 3px #fff
    }
    .lang select{border:2px solid #C7D2FE;background:#fff;border-radius:999px;padding:6px 10px;font-weight:900}

    /* Nav (centered) */
    nav.main{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding:10px 16px;background:#fff;border-top:1px dashed #C7D2FE
    }
    .tab{
      appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:900;cursor:pointer;
      color:#0B255F;background:#DBEAFE;
      box-shadow:0 6px 14px rgba(37,99,235,.15);
      transition:transform .08s ease, box-shadow .2s ease, background .2s ease
    }
    .tab:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(37,99,235,.25)}
    .tab.active{background:var(--blue);color:#fff;box-shadow:0 10px 22px rgba(37,99,235,.35)}
    .tab:focus-visible{outline:3px solid var(--blue-dark)}

    main{max-width:1140px;margin:0 auto;padding:20px 14px 100px}
    .view{display:none}.view.active{display:block}

    /* Hero + cards (center headings) */
    .hero{
      position:relative;overflow:hidden;isolation:isolate;background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:26px;text-align:center
    }
    .hero::after{
      content:"";position:absolute;right:-120px;top:-120px;width:300px;height:300px;border-radius:50%;
      background:radial-gradient(closest-side, rgba(56,189,248,.35), transparent 70%);filter:blur(18px);animation:pulse 6s ease-in-out infinite
    }
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .cta{
      display:inline-block;margin-top:12px;margin-right:10px;text-decoration:none;font-weight:900;padding:12px 16px;border-radius:12px;color:#082B7F;background:#DBEAFE;box-shadow:0 10px 20px rgba(37,99,235,.18);transition:transform .1s ease, box-shadow .2s ease
    }
    .cta:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(37,99,235,.28)}
    .cta.secondary{background:var(--blue);color:#fff;box-shadow:0 10px 22px rgba(37,99,235,.30)}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-top:16px}
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;position:relative;overflow:hidden;text-align:center;transition:transform .08s ease, box-shadow .2s ease}
    .card::before{content:"";position:absolute;inset:-40% auto auto -40%;width:180px;height:180px;border-radius:50%;background:radial-gradient(closest-side, rgba(37,99,235,.08), transparent 70%);transform:rotate(18deg)}
    .card:hover{transform:translateY(-3px);box-shadow:0 18px 38px rgba(2,6,23,.16)}

    .muted{color:var(--muted)} .tiny{font-size:.92rem}
    .panel{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}

    /* Tools */
    .tools{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .toggle{display:flex;align-items:center;gap:10px;margin:.35rem 0}
    .toggle input{accent-color:var(--blue)}
    .flash{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .flip{position:relative;perspective:800px;height:120px;cursor:pointer}
    .flip>div{position:absolute;inset:0;border-radius:12px;display:grid;place-items:center;padding:10px;backface-visibility:hidden;transition:transform .5s;box-shadow:var(--shadow)}
    .flip .front{background:#F0F7FF;border:2px solid #D8E6FF}
    .flip .back{background:#E6F6FF;border:2px solid #CDEBFF;transform:rotateY(180deg)}
    .flip.active .front{transform:rotateY(180deg)} .flip.active .back{transform:rotateY(360deg)}

    /* Chat */
    .safety{background:#E6F6FF;border:2px dashed var(--sky);padding:12px;border-radius:12px;margin:8px 0;font-weight:900;text-align:center}
    .age{display:flex;gap:12px;align-items:center;justify-content:center;font-weight:900}
    .chat{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .log{max-height:420px;min-height:240px;overflow:auto;padding:16px;background:linear-gradient(180deg,#fff,#F8FBFF)}
    .b{display:inline-block;padding:10px 12px;border-radius:14px;margin:8px 0;max-width:80%;line-height:1.45;animation:fadeIn .18s ease}
    .b.u{background:var(--blue);color:#fff;border-bottom-right-radius:4px}
    .b.s{background:#fff; border:2px solid var(--sky); color:#0B255F; border-bottom-left-radius:4px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .chat-form{display:flex;gap:10px;border-top:1px solid #E3F0FF;padding:12px}
    .chat-form input{flex:1;padding:12px 14px;border-radius:12px;border:2px solid #D6E8FF}
    .chat-form input:focus-visible{outline:none;border-color:var(--blue)}
    .send{background:#DBEAFE;color:#082B7F;border:0;border-radius:12px;font-weight:900;padding:12px 16px;cursor:pointer;box-shadow:0 8px 16px rgba(37,99,235,.20)}

    /* Game */
    .game-wrap{display:grid;grid-template-columns:1.4fr .9fr;gap:16px}
    .hud{display:flex;justify-content:space-between;gap:10px;margin:8px 0;font-weight:900}
    .btn{background:var(--blue);color:#fff;border:0;border-radius:10px;padding:10px 12px;font-weight:900;cursor:pointer;box-shadow:0 8px 18px rgba(37,99,235,.30)}
    .btn.secondary{background:#DBEAFE;color:#082B7F;box-shadow:0 8px 18px rgba(37,99,235,.18)}
    .pill{display:inline-block;background:#F0F7FF;border:2px solid #D8E6FF;color:#0B255F;border-radius:999px;padding:4px 8px;font-weight:900}
    .canvas-wrap{background:#fff;border-radius:12px;border:2px solid #CDEBFF;padding:10px}
    .canvas-wrap:focus{outline:3px solid var(--blue)}

    /* Reveal */
    .reveal{opacity:0;transform:translateY(10px);transition:all .5s ease}
    .reveal.show{opacity:1;transform:translateY(0)}

    footer{padding:26px 12px;text-align:center;color:var(--muted)}
    #confetti{pointer-events:none;position:fixed;inset:0}
    .confetti{position:absolute;font-size:18px;filter:drop-shadow(0 4px 8px rgba(0,0,0,.12));animation:fall 1.8s ease-out forwards}
    @keyframes fall{0%{transform:translateY(-20px) rotate(0);opacity:0}15%{opacity:1}100%{transform:translateY(92vh) rotate(260deg);opacity:0}}
    @media (max-width:900px){.game-wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="bar">
      <div class="brand">
        <!-- Centered shield icon -->
        <svg class="logo" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0%" stop-color="#2563EB"/>
              <stop offset="100%" stop-color="#38BDF8"/>
            </linearGradient>
          </defs>
          <path d="M48 10c10 8 19 10 30 12-1 24-11 40-30 52C29 62 19 46 18 22c11-2 20-4 30-12z" fill="url(#g1)" stroke="#1E40AF" stroke-width="2"/>
          <path d="M48 28l4 8 9 1-7 6 2 9-8-4-8 4 2-9-7-6 9-1 4-8z" fill="#fff"/>
        </svg>
        <div>
          <h1 class="title">SafeSurf Kids</h1>
          <p class="tagline">Learn smart, safe, and kind ICT üíô</p>
        </div>
      </div>
      <div class="actions">
        <div class="progress" aria-live="polite" title="Your progress">
          <div class="ring" id="ring"><span id="pct">0%</span></div>
          <span>Stars:</span><strong id="stars">0</strong>
        </div>
        <div class="lang">
          <label class="visually-hidden" for="langSel">Language</label>
          <select id="langSel">
            <option value="en" selected>EN</option>
            <option value="es">ES</option>
          </select>
        </div>
      </div>
    </div>
    <nav class="main" aria-label="Main">
      <button class="tab active" data-target="home">Home</button>
      <button class="tab" data-target="learn">Learn</button>
      <button class="tab" data-target="tools">Tools</button>
      <button class="tab" data-target="ask">Ask Spark</button>
      <button class="tab" data-target="game">Game</button>
      <button class="tab" data-target="parents">Parents</button>
      <button class="tab" data-target="resources">Resources</button>
    </nav>
  </header>

  <main>
    <!-- Home -->
    <section id="home" class="view active" aria-labelledby="home-h">
      <div class="hero reveal">
        <h2 id="home-h">Welcome! üåà</h2>
        <p class="muted">Quick lessons, playful tools, a friendly AI helper, and a fun game ‚Äî all about staying safe with ICT.</p>
        <a href="#learn" class="cta" data-go="learn">Start Learning</a>
        <a href="#ask" class="cta secondary" data-go="ask">Ask the AI</a>
      </div>
      <div class="grid" role="list">
        <article class="card reveal" role="listitem" tabindex="0">
          <h3>üîê Strong Passwords</h3><p>Use long, secret passwords. Turn on 2FA!</p>
        </article>
        <article class="card reveal" role="listitem" tabindex="0">
          <h3>üé£ Spot Scams</h3><p>Check links. Don‚Äôt share logins. Ask an adult.</p>
        </article>
        <article class="card reveal" role="listitem" tabindex="0">
          <h3>üí¨ Be Kind Online</h3><p>Block/report meanness. Save evidence. Talk to an adult.</p>
        </article>
        <article class="card reveal" role="listitem" tabindex="0">
          <h3>üë£ Digital Footprints</h3><p>Think before you post; the internet remembers.</p>
        </article>
      </div>
    </section>

    <!-- Learn -->
    <section id="learn" class="view" aria-labelledby="learn-h">
      <h2 id="learn-h" class="reveal">Learn: Safety Modules</h2>
      <p class="muted reveal">Tap a card to read tips, try a scenario, and take a quick quiz.</p>
      <div id="modules" class="grid" role="list"></div>
      <div id="moduleDetail" class="panel reveal" hidden aria-live="polite"></div>
    </section>

    <!-- Tools -->
    <section id="tools" class="view" aria-labelledby="tools-h">
      <h2 id="tools-h" class="reveal">Tools & Activities</h2>
      <div class="tools">
        <div class="panel reveal">
          <h3>‚úÖ Safety Checklist</h3>
          <div class="toggle"><input type="checkbox" id="t1"><label for="t1">I use long passwords (12+)</label></div>
          <div class="toggle"><input type="checkbox" id="t2"><label for="t2">I turned on 2FA</label></div>
          <div class="toggle"><input type="checkbox" id="t3"><label for="t3">My profiles are private</label></div>
          <div class="toggle"><input type="checkbox" id="t4"><label for="t4">I don‚Äôt post location</label></div>
          <div class="toggle"><input type="checkbox" id="t5"><label for="t5">I block/report unkind messages</label></div>
          <p class="tiny muted" id="checkDone"></p>
        </div>
        <div class="panel reveal">
          <h3>üß† Flashcards: Do / Don‚Äôt</h3>
          <div class="flash">
            <div class="flip"><div class="front">Share strong passwords?</div><div class="back">Don‚Äôt share passwords ‚Äî keep them secret üîê</div></div>
            <div class="flip"><div class="front">Click weird prize links?</div><div class="back">Don‚Äôt click ‚Äî likely scams üé£</div></div>
            <div class="flip"><div class="front">Ask before posting friends?</div><div class="back">Yes ‚Äî ask permission üì∏</div></div>
            <div class="flip"><div class="front">Be kind in comments?</div><div class="back">Yes ‚Äî kindness first üíô</div></div>
          </div>
        </div>
        <div class="panel reveal">
          <h3>üîê Password Helper</h3>
          <p class="tiny muted">Try a pretend password (don‚Äôt use a real one).</p>
          <input id="pw" type="text" placeholder="Type a pretend password‚Ä¶" style="width:100%;padding:10px;border-radius:10px;border:2px solid #D6E8FF">
          <p class="tiny"><strong>Strength:</strong> <span id="pwOut">‚Äì</span></p>
          <button class="btn secondary" id="pwIdea">Give me ideas</button>
          <p class="tiny muted" id="pwIdeas"></p>
        </div>
        <div class="panel reveal">
          <h3>üé£ Phishing Spotter</h3>
          <p class="tiny">Is this message safe?</p>
          <blockquote style="background:#F8FBFF;border-left:6px solid var(--sky);padding:8px;border-radius:8px">‚ÄúURGENT! Free phone! Click this link and log in now.‚Äù</blockquote>
          <button class="btn secondary" id="phishBtn">Check</button>
          <p id="phishOut" class="tiny muted"></p>
        </div>
      </div>
    </section>

    <!-- Ask Spark -->
    <section id="ask" class="view" aria-labelledby="ask-h">
      <h2 id="ask-h" class="reveal">Ask Spark (AI)</h2>
      <div class="safety reveal">Never share your real name, address, phone, school, or passwords.</div>
      <div class="age reveal">
        <label><input type="radio" name="age" value="8-10" checked> 8‚Äì10</label>
        <label><input type="radio" name="age" value="11-13"> 11‚Äì13</label>
      </div>
      <div class="chat reveal">
        <div id="chatLog" class="log" role="log" aria-live="polite" aria-relevant="additions"></div>
        <form id="chatForm" class="chat-form" autocomplete="off">
          <label for="chatInput" class="visually-hidden">Your message</label>
          <input id="chatInput" type="text" minlength="1" maxlength="600" placeholder="Ask me about staying safe online!" required />
          <button class="send" type="submit">Send</button>
        </form>
        <p class="tiny muted">We don‚Äôt store chats. Keep info private.</p>
      </div>
    </section>

    <!-- Game -->
    <section id="game" class="view" aria-labelledby="game-h">
      <h2 id="game-h" class="reveal">Runner Game: Dodge the Bad Stuff!</h2>
      <div class="game-wrap">
        <div class="panel reveal">
          <div class="hud">
            <div>Score: <span id="score">0</span></div>
            <div>High: <span id="hi">0</span></div>
            <div>Lives: <span id="lives">3</span></div>
          </div>
          <div id="canvasWrap" class="canvas-wrap" tabindex="0">
            <canvas id="runner" width="800" height="280" aria-label="Runner game"></canvas>
          </div>
          <div class="hud">
            <button class="btn" id="startBtn">Start</button>
            <button class="btn secondary" id="pauseBtn">Pause</button>
            <button class="btn secondary" id="resetBtn">Reset</button>
            <div class="pill">Jump: ‚Üí (Right Arrow)</div>
          </div>
        </div>
        <div class="panel reveal">
          <h3>How to play</h3>
          <ul>
            <li>Press Right Arrow to jump over bad ICT obstacles: üé£ phishing, üò° bullying, üîó weird links, üì∏ oversharing.</li>
            <li>Collect ‚≠ê stars for points.</li>
            <li>3 lives. The longer you run, the faster it gets.</li>
          </ul>
          <h4>Safety tips you‚Äôll see</h4>
          <ul class="tiny">
            <li>Never share passwords, address, phone, or school.</li>
            <li>Don‚Äôt click strange links or prizes.</li>
            <li>Be kind online. Block and report meanness.</li>
            <li>Ask a trusted adult if unsure.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Parents -->
    <section id="parents" class="view" aria-labelledby="parents-h">
      <h2 id="parents-h" class="reveal">Parent & Carer Corner</h2>
      <div class="grid">
        <article class="card reveal"><h3>Quick Tips</h3>
          <ul>
            <li>Talk early and often about online kindness and privacy.</li>
            <li>Set clear, shared rules (no devices in bedrooms at night).</li>
            <li>Use family accounts and enable parental controls where helpful.</li>
            <li>Play/learn the apps together; keep dialogue open.</li>
            <li>Use strong passwords & 2FA; keep devices updated.</li>
          </ul>
        </article>
        <article class="card reveal"><h3>Conversation Starters</h3>
          <ul>
            <li>How do you decide what to share online?</li>
            <li>What would you do if someone asked for private info?</li>
            <li>Which creators make you feel good? Why?</li>
          </ul>
        </article>
        <article class="card reveal"><h3>Signs to Watch</h3>
          <ul>
            <li>Worry about going online, mood shifts.</li>
            <li>Secret new accounts or hiding screens.</li>
            <li>Unexpected charges or ‚Äúnew friends‚Äù.</li>
          </ul>
        </article>
      </div>
    </section>

    <!-- Resources -->
    <section id="resources" class="view" aria-labelledby="resources-h">
      <h2 id="resources-h" class="reveal">Resources</h2>
      <div class="grid">
        <article class="card reveal"><h3>If you need help</h3>
          <ul>
            <li>Talk to a trusted adult (parent, carer, teacher, counselor).</li>
            <li>If you are in danger, contact local emergency services right away.</li>
            <li>Use app/game ‚ÄúReport‚Äù and ‚ÄúBlock‚Äù.</li>
          </ul>
        </article>
        <article class="card reveal"><h3>Helpful links</h3>
          <ul>
            <li><a href="https://www.childline.org.uk" target="_blank" rel="noopener">Childline (UK)</a></li>
            <li><a href="https://www.kidshelpphone.ca" target="_blank" rel="noopener">Kids Help Phone (CA)</a></li>
            <li><a href="https://www.stopbullying.gov" target="_blank" rel="noopener">StopBullying.gov (US)</a></li>
            <li><a href="https://www.commonsensemedia.org" target="_blank" rel="noopener">Common Sense Media</a></li>
          </ul>
          <p class="tiny muted">Links are examples ‚Äî find local help in your area.</p>
        </article>
      </div>
    </section>
  </main>

  <div id="confetti" aria-hidden="true"></div>
  <footer>¬© <span id="year"></span> SafeSurf Kids ¬∑ <span class="tiny">We don‚Äôt collect personal data.</span></footer>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      // ===== Config (unchanged; uses your Worker) =====
      const USE_BACKEND = true;
      const BACKEND_URL = 'https://spark-ai-sethu.sethu-spark.workers.dev';

      // ===== Helpers & State =====
      const $ = (s, c=document) => c.querySelector(s);
      const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));
      let completed = new Set(JSON.parse(localStorage.getItem('ss-completed')||'[]'));
      let ageGroup = '8-10';
      $('#year') && ($('#year').textContent = new Date().getFullYear());

      // Tabs
      $$('.tab').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id=btn.dataset.target;
          $$('.view').forEach(v=>v.classList.toggle('active', v.id===id));
          $$('.tab').forEach(b=>b.classList.toggle('active', b===btn));
          window.scrollTo({top:0,behavior:'smooth'});
        });
      });
      $$('[data-go]').forEach(a=>a.addEventListener('click',e=>{
        e.preventDefault();
        const id=a.getAttribute('data-go');
        document.querySelector(`.tab[data-target="${id}"]`)?.click();
      }));

      // Reveal on scroll
      const io = new IntersectionObserver(entries=>{
        entries.forEach(e=>e.target.classList.toggle('show', e.isIntersecting));
      },{threshold:.12});
      $$('.reveal').forEach(el=>io.observe(el));

      // ===== 10 Learning Modules =====
      const LESSONS = [
        { id:'passwords',emoji:'üîê',title:'Strong Passwords & 2FA',subtitle:'Make your accounts tough to crack!',
          tips:['Use long passwords (12+). Try three random words.','Never share passwords with friends.','Use a different password for each account.','Turn on 2FA ‚Äî a code from an app or text.','Keep devices locked with a PIN or passcode.'],
          scenario:{ prompt:'A message says: ‚ÄúYour account is locked! Send your password to fix it.‚Äù What do you do?',
            choices:[{text:'Send my password to unlock it',feedback:'Nope! Never share passwords. This is likely a scam.'},{text:'Ignore and go to the official app/website',feedback:'Yes! Use the real app/website and change your password if worried.'},{text:'Ask friends if they got the same message',feedback:'Better to check the official site instead of asking friends.'}]
          },
          quiz:[{q:'What makes a strong password?',options:['Your name + birthday','12+ characters with random words','12345678'],answerIndex:1},{q:'What is 2FA?',options:['A gaming level','A code to prove it‚Äôs you','An emoji'],answerIndex:1},{q:'Should you share passwords?',options:['Yes','No'],answerIndex:1}]
        },
        { id:'privacy',emoji:'üõ°Ô∏è',title:'Privacy & Sharing',subtitle:'Think before you post.',
          tips:['Keep real name, address, phone, and school private.','Turn off location sharing.','Check privacy settings for posts and profiles.','Ask before sharing photos of friends.','Be kind ‚Äî your future self will thank you!'],
          scenario:{ prompt:'A new friend asks for your address to send a gift. What do you do?',
            choices:[{text:'Share it in chat',feedback:'Not safe. Never share your home address online.'},{text:'Say no and ask a trusted adult',feedback:'Great choice! Keep private info safe and talk to an adult.'},{text:'Give a nearby place instead',feedback:'Still risky. Don‚Äôt share locations online.'}]
          },
          quiz:[{q:'What info should stay private?',options:['Real name & address','Favorite color'],answerIndex:0},{q:'Ask before posting a group photo?',options:['No','Yes ‚Äî ask them'],answerIndex:1},{q:'Location sharing?',options:['Always on','Turn it off unless needed'],answerIndex:1}]
        },
        { id:'cyberbullying',emoji:'üí¨',title:'Cyberbullying',subtitle:'Be kind, block, and report.',
          tips:['If someone is unkind, don‚Äôt reply. Save evidence.','Use block and report ‚Äî it‚Äôs safety.','Talk to a trusted adult right away.','Be kind when you comment and message.','Check in on friends who seem down.'],
          scenario:{ prompt:'Someone keeps sending mean messages in a group chat. What now?',
            choices:[{text:'Send mean messages back',feedback:'This can make it worse. Don‚Äôt reply.'},{text:'Block, report, and tell a trusted adult',feedback:'That‚Äôs right! Block/report and talk to an adult.'},{text:'Leave the group and never tell anyone',feedback:'Leaving can help, but also tell a trusted adult.'}]
          },
          quiz:[{q:'Keep as evidence?',options:['Screenshots','Nothing'],answerIndex:0},{q:'Who can you talk to?',options:['A trusted adult','No one'],answerIndex:0},{q:'Apps can help you‚Ä¶',options:['Block/report','Be mean back'],answerIndex:0}]
        },
        { id:'scams',emoji:'üé£',title:'Scams & Phishing',subtitle:'Spot tricks before they get you.',
          tips:['Don‚Äôt click strange links or attachments.','Check the sender ‚Äî fakes look similar.','Look for urgent threats & spelling mistakes.','Use the official app/website to check accounts.','Ask an adult if anything feels off.'],
          scenario:{ prompt:'You win a ‚Äúfree phone‚Äù if you click a link. It asks for your login. What now?',
            choices:[{text:'Enter my login to get the prize',feedback:'This is a phishing trick. Don‚Äôt share logins.'},{text:'Close it and tell a trusted adult',feedback:'Good move! Stay safe and double-check with an adult.'},{text:'Click the link but don‚Äôt type anything',feedback:'Even clicking can be risky. Better to close it.'}]
          },
          quiz:[{q:'Which looks suspicious?',options:['Weird links & urgent prizes','A message from your parent'],answerIndex:0},{q:'Where to check your account?',options:['Official app/website','Random link'],answerIndex:0},{q:'Who can help if unsure?',options:['Trusted adult','A stranger online'],answerIndex:0}]
        },
        { id:'gaming',emoji:'üéÆ',title:'Gaming Safety',subtitle:'Play fun, play fair, take breaks.',
          tips:['Use family-friendly chats and block rude players.','Ask before buying in-game items.','Take eye-and-body breaks every 30‚Äì60 mins.','Don‚Äôt share private info in voice chat.','Balance games with sleep, school, and friends.'],
          scenario:{ prompt:'A player asks for your login to ‚Äúboost‚Äù your account. What do you do?',
            choices:[{text:'Share it ‚Äî I want better items',feedback:'Nope! Never share logins. They could steal your account.'},{text:'Say no, block, and report',feedback:'Perfect. Protect your account and move on.'},{text:'Share only the password',feedback:'That‚Äôs the most secret part. Keep it private!'}]
          },
          quiz:[{q:'Breaks?',options:['Every 30‚Äì60 mins','Never'],answerIndex:0},{q:'In‚Äëapp purchases?',options:['Ask a parent first','Buy anything'],answerIndex:0},{q:'Keep private in voice chat?',options:['Address & school','Game tips'],answerIndex:0}]
        },
        { id:'footprints',emoji:'üë£',title:'Digital Footprints',subtitle:'What you post can last.',
          tips:['Posts can travel fast and be saved.','Be proud of what future‚Äëyou will see.','Think: Kind? True? Needed?','Ask before posting others.','Review old posts and clean up.'],
          scenario:{ prompt:'You find a silly video of your friend and want to post it. What now?',
            choices:[{text:'Post it ‚Äî it‚Äôs funny!',feedback:'It could hurt feelings. Always ask first.'},{text:'Ask your friend if it‚Äôs okay',feedback:'Yes! Get permission before posting.'},{text:'Post now, remove later',feedback:'It might be copied. Better to ask first.'}]
          },
          quiz:[{q:'Digital footprint is‚Ä¶',options:['Your shoe size','Your online posts/actions'],answerIndex:1},{q:'Share group pics?',options:['No ask','Ask people in photo'],answerIndex:1},{q:'Do deleted posts vanish?',options:['Always','Not always ‚Äî others may save'],answerIndex:1}]
        },
        { id:'ai',emoji:'üß†',title:'AI, Photos & Deepfakes',subtitle:'Not everything is real.',
          tips:['Weird videos may be AI‚Äëmade.','Check trusted news or official pages.','Look for odd eyes, lighting, or lips.','Don‚Äôt share shocking clips before checking.','Ask an adult if unsure.'],
          scenario:{ prompt:'A video shows your favorite creator saying something rude. It looks off. What do you do?',
            choices:[{text:'Share it fast!',feedback:'Wait! It could be fake. Don‚Äôt spread it.'},{text:'Check their official page',feedback:'Smart! Verify first.'},{text:'Post a rude comment',feedback:'Be kind ‚Äî verify first.'}]
          },
          quiz:[{q:'Deepfake is‚Ä¶',options:['A cookie','A realistic fake made with AI'],answerIndex:1},{q:'Share shocking clips quickly?',options:['Yes','No ‚Äî check first'],answerIndex:1},{q:'If unsure‚Ä¶',options:['Ask an adult','Guess'],answerIndex:0}]
        },
        { id:'social',emoji:'üì±',title:'Smart Social Sharing',subtitle:'Share happy, share wisely.',
          tips:['Use private accounts if possible.','Hide personal info from profiles.','Turn off location on posts.','Be kind in comments and messages.','Report fake or rude accounts.'],
          scenario:{ prompt:'An app asks to access your contacts and location. What now?',
            choices:[{text:'Allow everything',feedback:'Only allow what you need.'},{text:'Allow only needed or say no',feedback:'Nice! Keep info safe.'},{text:'Share your password too',feedback:'Never share passwords.'}]
          },
          quiz:[{q:'Safer for kids?',options:['Public','Private'],answerIndex:1},{q:'Share location?',options:['Always','Only if needed'],answerIndex:1},{q:'Rude person?',options:['Be rude back','Block/report & tell adult'],answerIndex:1}]
        },
        { id:'devices',emoji:'üîß',title:'Device & Wi‚ÄëFi Safety',subtitle:'Keep tech healthy.',
          tips:['Update apps and system often.','Use secure Wi‚ÄëFi; avoid unknown public Wi‚ÄëFi for logins.','Don‚Äôt install random files.','Use PIN/biometrics to lock your device.','Ask an adult before changing settings.'],
          scenario:{ prompt:'You‚Äôre on free public Wi‚ÄëFi. A site asks for your login. What do you do?',
            choices:[{text:'Log in now',feedback:'Public Wi‚ÄëFi can be risky. Avoid logins there.'},{text:'Wait and log in at home/data',feedback:'Great choice ‚Äî stay safe!'},{text:'Download a random ‚Äúsecurity‚Äù app',feedback:'Only install trusted apps.'}]
          },
          quiz:[{q:'Updates?',options:['Ignore','Install'],answerIndex:1},{q:'Public Wi‚ÄëFi is‚Ä¶',options:['Always safe','Risky for logins'],answerIndex:1},{q:'Best phone lock?',options:['No lock','PIN/biometrics'],answerIndex:1}]
        },
        { id:'wellbeing',emoji:'üßò',title:'Screen Time & Well‚Äëbeing',subtitle:'Balance screens and life.',
          tips:['Take breaks for eyes and body.','Sleep phones outside bedrooms.','Spend time offline with friends and hobbies.','Notice how apps make you feel.','Ask for help if you feel stressed.'],
          scenario:{ prompt:'You feel grumpy after lots of scrolling. What can help?',
            choices:[{text:'Scroll more to feel better',feedback:'More scrolling can make it worse.'},{text:'Take a break and do something offline',feedback:'Great idea ‚Äî move, stretch, or chat with family.'},{text:'Send rude comments',feedback:'Kindness first ‚Äî take a break instead.'}]
          },
          quiz:[{q:'Good break time?',options:['Every 30‚Äì60 mins','Never'],answerIndex:0},{q:'Phones at bedtime?',options:['Outside bedrooms','Under the pillow'],answerIndex:0},{q:'Feeling bad online?',options:['Keep scrolling','Talk to a trusted adult'],answerIndex:1}]
        }
      ];

      function updateStars(){ const s=$('#stars'); if (s) s.textContent = String(completed.size); }
      function updateProgress(){
        const total = LESSONS.length, done = completed.size;
        const pct = Math.round((done/total)*100);
        $('#pct')?.textContent = pct + '%';
        $('#ring')?.style.setProperty('--angle', pct + '%');
      }

      function renderModules(){
        const wrap = $('#modules'); if (!wrap) return;
        wrap.innerHTML='';
        LESSONS.forEach(m=>{
          const card=document.createElement('button'); card.className='card reveal'; card.setAttribute('role','listitem');
          card.innerHTML=`<h3>${m.emoji} ${m.title}</h3><p class="muted">${m.subtitle}</p><div class="tiny">${m.tips.slice(0,3).map(t=>'‚Ä¢ '+t).join('<br>')}</div>`;
          io.observe(card);
          card.addEventListener('click',()=>openModule(m.id));
          wrap.appendChild(card);
        });
        updateProgress();
      }

      function openModule(id){
        const m=LESSONS.find(x=>x.id===id); const box=$('#moduleDetail'); if(!m||!box) return;
        box.hidden=false; window.location.hash=`#module-${id}`; const done=completed.has(id);
        box.innerHTML=`
          <div><h3 style="text-align:center">${m.emoji} ${m.title}</h3><p class="muted" style="text-align:center">${m.subtitle}</p></div>
          <div class="tips"><h4>Top Tips</h4><ul>${m.tips.map(t=>`<li>${t}</li>`).join('')}</ul></div>
          <div class="scenario"><h4>Try a Scenario</h4><p>${m.scenario.prompt}</p>
            <div class="grid">${m.scenario.choices.map((c,i)=>`<button class="btn secondary" data-choice="${i}">${c.text}</button>`).join('')}</div>
            <p id="scOut" class="tiny muted" aria-live="polite"></p>
          </div>
          <div class="quiz"><h4>Quick Quiz</h4>
            <form id="q-${id}">
              ${m.quiz.map((q,qi)=>`
                <fieldset class="card" style="padding:12px">
                  <legend><strong>${qi+1}.</strong> ${q.q}</legend>
                  ${q.options.map((opt,oi)=>`<label><input type="radio" name="q${qi}" value="${oi}" required> ${opt}</label><br>`).join('')}
                </fieldset>
              `).join('')}
              <button class="cta" type="submit">Check Answers</button>
            </form>
            <p id="qr" class="muted" aria-live="polite"></p>
            <div class="tiny">${done?'‚úÖ Quiz completed ‚Äî star awarded!':''}</div>
          </div>`;
        $$('.scenario .btn',box).forEach(b=>b.addEventListener('click',()=>{$('#scOut',box).textContent=m.scenario.choices[Number(b.dataset.choice)].feedback;}));
        $('#q-'+id,box).addEventListener('submit',e=>{
          e.preventDefault();
          const data=new FormData(e.target); let correct=0;
          m.quiz.forEach((q,qi)=>{ const v=data.get('q'+qi); if(v!==null && Number(v)===q.answerIndex) correct++; });
          const qr=$('#qr',box);
          if(correct===m.quiz.length){
            qr.textContent=`Great job! You got ${correct}/${m.quiz.length} üéâ`;
            if(!completed.has(id)){ completed.add(id); localStorage.setItem('ss-completed',JSON.stringify([...completed])); updateStars(); confetti(); updateProgress(); }
          }else qr.textContent=`You got ${correct}/${m.quiz.length}. Try again ‚Äî you can do it! üí™`;
        });
      }

      // Tools
      $$('#tools .toggle input').forEach(inp=>{
        inp.addEventListener('change',()=>{
          const n=$$('#tools .toggle input').filter(i=>i.checked).length;
          $('#checkDone')?.textContent = n>=5 ? 'Awesome! You checked all safety steps. ‚≠ê' : `${n}/5 done ‚Äî keep going!`;
        });
      });
      $$('.flip').forEach(f=>f.addEventListener('click',()=>f.classList.toggle('active')));
      $('#pw')?.addEventListener('input',e=>{
        const v=e.target.value; const s=pwScore(v); const w=['Very Weak','Weak','Okay','Good','Strong','Very Strong']; $('#pwOut')?.textContent=w[Math.min(w.length-1,s)];
      });
      function pwScore(p){ let s=0; if(p.length>=8)s++; if(p.length>=12)s++; if(/[A-Z]/.test(p))s++; if(/[0-9]/.test(p))s++; if(/[^A-Za-z0-9]/.test(p))s++; if(/\b(password|1234|qwerty|admin)\b/i.test(p)) s=Math.max(0,s-2); return s; }
      $('#pwIdea')?.addEventListener('click',()=>{
        const words=['Sunny','Rocket','Panda','Jazz','Mango','River','Puzzle','Galaxy','Ninja','Koala','Lemon','Zebra','Maple','Toast','Pixel'];
        const pick=()=>words[Math.floor(Math.random()*words.length)];
        const idea = `${pick()}-${pick()}-${pick()}-${Math.floor(10+Math.random()*89)}!`;
        $('#pwIdeas')?.textContent = `Try: ${idea} (don‚Äôt use real info)`;
      });
      $('#phishBtn')?.addEventListener('click',()=>{$('#phishOut')?.textContent='Looks phishing! üö´ Don‚Äôt click. Use the official app/site and ask a trusted adult.';});

      // ===== Chat (unchanged backend call) =====
      const chatLog=$('#chatLog'), chatForm=$('#chatForm'), chatInput=$('#chatInput');
      $$('input[name="age"]').forEach(r=>r.addEventListener('change',()=>ageGroup=r.value));
      function containsPII(t){
        const email=/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i;
        const phone=/(\+?\d{1,2}[\s.-]?)?(KATEX_INLINE_OPEN?\d{3}KATEX_INLINE_CLOSE?[\s.-]?)\d{3}[\s.-]?\d{4}\b/;
        const address=/\b\d{1,5}\s+\w+(?:\s+\w+){0,3}\s+(street|st|avenue|ave|road|rd|boulevard|blvd|lane|ln|drive|dr|court|ct)\b/i;
        const school=/\b(school|elementary|middle\s+school|high\s+school|academy|ps\s?\d+)\b/i;
        const password=/\bpassword\b\s*[:=]\s*\S+/i;
        const username=/\b(user(name)?|login)\b\s*[:=]\s*\S+/i;
        return email.test(t)||phone.test(t)||address.test(t)||school.test(t)||password.test(t)||username.test(t);
      }
      function addUser(t){ if(!chatLog) return; const b=document.createElement('div'); b.className='b u'; b.textContent=t; chatLog.appendChild(b); chatLog.scrollTop=chatLog.scrollHeight; }
      function addSpark(t){ if(!chatLog) return; const b=document.createElement('div'); b.className='b s'; b.textContent=t; chatLog.appendChild(b); chatLog.scrollTop=chatLog.scrollHeight; }
      function addTyping(){ if(!chatLog) return; const b=document.createElement('div'); b.className='b s'; b.innerHTML='<span class="typing"><span></span><span></span><span></span></span>'; b.dataset.t='1'; chatLog.appendChild(b); chatLog.scrollTop=chatLog.scrollHeight; }
      function removeTyping(){ if(!chatLog) return; const last=[...chatLog.querySelectorAll('.b.s')].reverse().find(x=>x.dataset.t==='1'); if(last) last.remove(); }
      chatForm?.addEventListener('submit', async e=>{
        e.preventDefault();
        const text=chatInput.value.trim(); if(!text) return;
        if(containsPII(text)){ addSpark("Let‚Äôs keep personal info private üëç Please don‚Äôt share your real name, address, phone number, school, email, or passwords. You can ask me about staying safe online, like passwords, privacy, bullying, or games! üåü"); chatInput.value=''; return; }
        addUser(text); chatInput.value=''; addTyping();
        try{
          const res=await fetch(BACKEND_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,ageGroup})});
          const data=await res.json(); removeTyping();
          if(data.ok) addSpark(data.reply||'Thanks for your message! üòä'); else addSpark(data.error||'Oops, I had trouble replying. Please try again.');
        }catch{ removeTyping(); addSpark('Network error. Please try again in a moment.'); }
      });

      // ===== Game: RIGHT ARROW ONLY =====
      const cvs=$('#runner'), ctx=cvs?.getContext('2d');
      const startBtn=$('#startBtn'), pauseBtn=$('#pauseBtn'), resetBtn=$('#resetBtn');

      // Hi‚ÄëDPI scaling
      let dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      function fitCanvas(){
        if(!cvs || !ctx) return;
        const cssW = cvs.clientWidth || 800;
        const cssH = 280;
        dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
        cvs.width = Math.floor(cssW * dpr);
        cvs.height = Math.floor(cssH * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        groundY = (cvs.height/dpr) - 50;
        draw();
      }
      addEventListener('resize', fitCanvas);
      fitCanvas();

      // World
      let running=false, paused=false, ended=false;
      let score=0, hi=Number(localStorage.getItem('ss-hi')||0), lives=3;
      let groundY = (cvs ? (cvs.height/dpr) - 50 : 230);
      let lastTime=0, speed=220; // px/s
      let spawnObstacleTimer=0, spawnStarTimer=0;
      let player = { x:80, y:groundY, w:28, h:34, vy:0, onGround:true, blink:0 };
      const obstacles=[], stars=[];
      const types = [
        {label:'Phish', emoji:'üé£', color:'#2563EB', w:28, h:28},
        {label:'Bullying', emoji:'üò°', color:'#1E40AF', w:30, h:30},
        {label:'Weird', emoji:'üîó', color:'#0B255F', w:26, h:26},
        {label:'Share', emoji:'üì∏', color:'#0284C7', w:28, h:28}
      ];

      function updateHUD(){ $('#score') && ($('#score').textContent=score); $('#hi') && ($('#hi').textContent=hi); $('#lives') && ($('#lives').textContent=lives); }
      function resetGame(){
        running=false; paused=false; ended=false;
        score=0; lives=3; speed=220; lastTime=0;
        obstacles.length=0; stars.length=0;
        player.y=groundY; player.vy=0; player.onGround=true; player.blink=0;
        updateHUD(); draw();
      }

      function drawGround(){
        if(!ctx||!cvs) return;
        const W = cvs.width/dpr;
        ctx.fillStyle='#DBEAFE'; ctx.fillRect(0, groundY+20, W, 6);
        ctx.fillStyle='#EFF6FF'; ctx.fillRect(0, groundY+26, W, 999);
      }
      function drawPlayer(){
        if(!ctx) return;
        const {x,y,w,h}=player;
        ctx.fillStyle=player.blink>0 && Math.floor(player.blink*10)%2===0 ? '#C7D2FE' : '#2563EB';
        ctx.fillRect(x-w/2, y-h, w, h);
        ctx.fillStyle='#fff'; ctx.fillRect(x-w/2+4, y-h+4, w-8, 10);
        ctx.fillStyle='#0F172A'; ctx.fillRect(x-w/2+7, y-h+6, 6,6); ctx.fillRect(x+w/2-13, y-h+6, 6,6);
        ctx.fillStyle='#1E40AF'; ctx.fillRect(x-w/2+2, y-6, 10,6); ctx.fillRect(x+4, y-6, 10,6);
      }
      function drawObstacles(){
        if(!ctx) return;
        obstacles.forEach(o=>{
          ctx.fillStyle=o.color; ctx.fillRect(o.x, o.y-o.h, o.w, o.h);
          ctx.font='14px system-ui'; ctx.fillStyle='#0F172A'; ctx.fillText(o.emoji, o.x+o.w/2-7, o.y-o.h-4);
        });
      }
      function drawStars(){
        if(!ctx) return;
        ctx.fillStyle='#38BDF8';
        stars.forEach(s=>{ ctx.beginPath(); ctx.arc(s.x, s.y, 7, 0, Math.PI*2); ctx.fill(); });
      }
      function draw(){ if(!ctx) return; ctx.clearRect(0,0,cvs.width,cvs.height); drawGround(); drawStars(); drawObstacles(); drawPlayer(); }
      function AABB(ax,ay,aw,ah, bx,by,bw,bh){ return ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by; }

      function spawn(dt){
        spawnObstacleTimer += dt*1000;
        spawnStarTimer += dt*1000;
        const obstacleEvery = Math.max(500, 1300 - (score/5));
        if(spawnObstacleTimer >= obstacleEvery){
          spawnObstacleTimer = 0;
          const t = types[Math.floor(Math.random()*types.length)];
          obstacles.push({ x:(cvs.width/dpr)+10, y:groundY, w:t.w, h:t.h, color:t.color, emoji:t.emoji, label:t.label });
        }
        if(spawnStarTimer >= 1800){
          spawnStarTimer = 0;
          const y = groundY - (60 + Math.random()*40);
          stars.push({ x:(cvs.width/dpr)+10, y });
        }
      }

      function update(dt){
        if(!running || paused || ended) return;
        if(!player.onGround){ player.vy += 1400*dt; player.y += player.vy*dt; if(player.y>=groundY){player.y=groundY; player.vy=0; player.onGround=true;} }
        if(player.blink>0){ player.blink = Math.max(0, player.blink - dt); }

        spawn(dt);

        const dx = speed*dt;
        for(let i=obstacles.length-1;i>=0;i--){
          const o=obstacles[i]; o.x -= dx; if(o.x+o.w < -20) obstacles.splice(i,1);
        }
        for(let i=stars.length-1;i>=0;i--){
          const s=stars[i]; s.x -= dx*0.9; if(s.x < -20) stars.splice(i,1);
        }

        const px = player.x - player.w/2, py = player.y - player.h, pw = player.w, ph = player.h;
        for(let i=obstacles.length-1;i>=0;i--){
          const o=obstacles[i];
          if(AABB(px,py,pw,ph, o.x, o.y-o.h, o.w, o.h)){
            obstacles.splice(i,1);
            if(player.blink<=0){
              lives--; player.blink=1.2; updateHUD();
              if(lives<=0){ endGame(); return; }
            }
          }
        }
        for(let i=stars.length-1;i>=0;i--){
          const s=stars[i];
          if(AABB(px,py,pw,ph, s.x-7, s.y-7, 14,14)){ score+=50; stars.splice(i,1); }
        }

        score += Math.floor(120*dt);
        if(score%600===0) speed = Math.min(speed+10, 420);
        updateHUD(); draw();
        requestAnimationFrame(loop);
      }

      function loop(ts){
        if(!running || paused || ended) return;
        if(!lastTime) lastTime = ts;
        const dt = Math.min(0.033, (ts - lastTime)/1000);
        lastTime = ts;
        update(dt);
      }

      function jump(){
        if(!running || paused || ended) return;
        if(player.onGround){ player.vy = -520; player.onGround=false; }
      }
      function endGame(){
        ended=true; running=false; paused=false;
        hi = Math.max(hi, score); localStorage.setItem('ss-hi', String(hi)); updateHUD();
        confetti();
        if(!ctx) return;
        ctx.save();
        ctx.fillStyle='rgba(255,255,255,.85)'; ctx.fillRect(0,0,cvs.width/dpr,cvs.height/dpr);
        ctx.fillStyle= '#1E40AF'; ctx.font='bold 28px Nunito'; ctx.fillText('Great run! Final score: '+score, 220, 120);
        ctx.fillStyle= '#0B255F'; ctx.font='bold 18px Nunito'; ctx.fillText('Press Start to try again.', 300, 160);
        ctx.restore();
      }

      // Controls: RIGHT ARROW only; ignore typing; prevent page horizontal scroll
      $('#startBtn')?.addEventListener('click', ()=>{
        $('#canvasWrap')?.focus({preventScroll:true});
        if(running && !paused) return;
        if(!running || ended){ resetGame(); running=true; lastTime=0; requestAnimationFrame(loop); }
        else { paused=false; requestAnimationFrame(loop); }
      });
      $('#pauseBtn')?.addEventListener('click', ()=>{ if(running && !ended){ paused=!paused; if(!paused) requestAnimationFrame(loop); } });
      $('#resetBtn')?.addEventListener('click', ()=>{ resetGame(); $('#canvasWrap')?.focus({preventScroll:true}); });

      window.addEventListener('keydown', (e)=>{
        const tag = (document.activeElement && document.activeElement.tagName || '').toLowerCase();
        if(tag==='input' || tag==='textarea' || tag==='select') return;
        const isRight = e.code === 'ArrowRight' || e.key === 'ArrowRight' || e.key === 'Right';
        if(isRight){ e.preventDefault(); jump(); }
      }, {capture:true});

      // Confetti
      function confetti(){
        const wrap=document.getElementById('confetti');
        for(let i=0;i<26;i++){
          const c=document.createElement('div'); c.className='confetti'; c.textContent=['‚≠ê','‚ú®','üåü'][Math.floor(Math.random()*3)];
          c.style.left=Math.random()*100+'vw'; c.style.top='-10px'; c.style.animationDelay=(Math.random()*0.5)+'s';
          c.style.transform=`scale(${0.7+Math.random()*0.8})`; wrap.appendChild(c); setTimeout(()=>c.remove(),2000);
        }
      }

      // Init
      function updateHUD(){ $('#score') && ($('#score').textContent=score); $('#hi') && ($('#hi').textContent=hi); $('#lives') && ($('#lives').textContent=lives); }
      const score=0, hi=Number(localStorage.getItem('ss-hi')||0), lives=3; // just for initial HUD read
      $('#hi') && ($('#hi').textContent = String(hi));
      renderModules(); updateStars(); updateProgress(); // draw() will be called by fitCanvas
    });
  </script>
</body>
</html>
